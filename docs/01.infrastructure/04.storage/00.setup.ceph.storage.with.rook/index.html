<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An overkill homelab setup"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Install the Cluster - Homelab</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CHackman&display=fallback"><style>body,input{font-family:"","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hackman","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=teal> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#components tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=../../.. title=Homelab class="md-header-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Homelab </span> <span class=md-header-nav__topic> Install the Cluster </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=../../.. title=Homelab class="md-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> Homelab </label> <div class=md-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Introduction class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Infrastructure </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.hosts/00.configuring.physical.nodes/ title="Host Configuration" class=md-nav__link> Host Configuration </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Hosts </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Hosts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-1 type=checkbox id=nav-2-2-1> <label class=md-nav__link for=nav-2-2-1> On-prem </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-1> On-prem </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.hosts/01.banks/ title="Compute (Banks)" class=md-nav__link> Compute (Banks) </a> </li> <li class=md-nav__item> <a href=../../01.hosts/02.clarke/ title="Storage (Clarke)" class=md-nav__link> Storage (Clarke) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-2 type=checkbox id=nav-2-2-2> <label class=md-nav__link for=nav-2-2-2> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-2> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.hosts/03.donaldson/ title="Compute (Donaldson)" class=md-nav__link> Compute (Donaldson) </a> </li> <li class=md-nav__item> <a href=../../01.hosts/04.hamilton/ title="Ingress (Hamilton)" class=md-nav__link> Ingress (Hamilton) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Kubernetes Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Kubernetes Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02.kubernetes/00.configuring.kubernetes/ title="Install Kubernetes" class=md-nav__link> Install Kubernetes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2> <label class=md-nav__link for=nav-2-3-2> Initial Networking </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-2> Initial Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02.kubernetes/01.cni/ title=CNI class=md-nav__link> CNI </a> </li> <li class=md-nav__item> <a href=../../02.kubernetes/02.metallb/ title="Load Balancer" class=md-nav__link> Load Balancer </a> </li> <li class=md-nav__item> <a href=../../02.kubernetes/03.ingress/ title=Ingress class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../03.certificates/00.cert.manager/ title="TLS Certificates Management" class=md-nav__link> TLS Certificates Management </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5 checked> <label class=md-nav__link for=nav-2-5> CEPH Storage with Rook </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> CEPH Storage with Rook </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Install the Cluster </label> <a href=./ title="Install the Cluster" class="md-nav__link md-nav__link--active"> Install the Cluster </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#components class=md-nav__link> Components </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rook class=md-nav__link> Rook </a> </li> <li class=md-nav__item> <a href=#ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#installation-and-setup class=md-nav__link> Installation and Setup </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deployment-of-the-rook-operator class=md-nav__link> Deployment of the Rook operator </a> </li> <li class=md-nav__item> <a href=#create-the-rook-cluster class=md-nav__link> Create the Rook cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#toubleshooting-not-all-osds-disks-are-created class=md-nav__link> Toubleshooting: Not all OSDs (disks) are created </a> </li> <li class=md-nav__item> <a href=#troubleshooting-errno-2 class=md-nav__link> Troubleshooting: [errno 2] </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dashboard-and-storage class=md-nav__link> Dashboard and Storage </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../01.dashboard/ title="Setup Dashboard" class=md-nav__link> Setup Dashboard </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5-3 type=checkbox id=nav-2-5-3> <label class=md-nav__link for=nav-2-5-3> Storage Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-5-3> Storage Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../02.storage/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../0200.block/ title=Block class=md-nav__link> Block </a> </li> <li class=md-nav__item> <a href=../0201.filesystem/ title=Filesystem class=md-nav__link> Filesystem </a> </li> <li class=md-nav__item> <a href=../0202.object/ title=Object class=md-nav__link> Object </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-6 type=checkbox id=nav-2-6> <label class=md-nav__link for=nav-2-6> Monitoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-6> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../05.monitoring/00.monitoring.with.prometheus.and.grafana/ title="Prometheus and Grafana" class=md-nav__link> Prometheus and Grafana </a> </li> <li class=md-nav__item> <a href=../../05.monitoring/01.kubernetes.dashboard/ title="Kubernetes Dashboard" class=md-nav__link> Kubernetes Dashboard </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Identity and Access Management (IDAM) </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Identity and Access Management (IDAM) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../02.idam/00.idam/ title="IDAM Overview" class=md-nav__link> IDAM Overview </a> </li> <li class=md-nav__item> <a href=../../../02.idam/01.openldap/ title=OpenLDAP class=md-nav__link> OpenLDAP </a> </li> <li class=md-nav__item> <a href=../../../02.idam/02.keycloak/ title=Keycloak class=md-nav__link> Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Integration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../02.idam/03.integration/00.integration/ title=Overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../02.idam/03.integration/01.kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Snippets </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Snippets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../99.snippets/storage.disks/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../../99.snippets/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../99.snippets/ceph/ title=Ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#components class=md-nav__link> Components </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rook class=md-nav__link> Rook </a> </li> <li class=md-nav__item> <a href=#ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#installation-and-setup class=md-nav__link> Installation and Setup </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deployment-of-the-rook-operator class=md-nav__link> Deployment of the Rook operator </a> </li> <li class=md-nav__item> <a href=#create-the-rook-cluster class=md-nav__link> Create the Rook cluster </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#toubleshooting-not-all-osds-disks-are-created class=md-nav__link> Toubleshooting: Not all OSDs (disks) are created </a> </li> <li class=md-nav__item> <a href=#troubleshooting-errno-2 class=md-nav__link> Troubleshooting: [errno 2] </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#dashboard-and-storage class=md-nav__link> Dashboard and Storage </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/darth-veitcher/homelab/edit/master/docs/01.infrastructure/04.storage/00.setup.ceph.storage.with.rook.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>Install the Cluster</h1> <p>In <a href>part 2</a> we installed Kubernetes and setup a user (in my case <code>adminlocal</code>) on our cluster with the ability to run administrative kubernetes commands.</p> <p>etcd (key/value store), Rook, Promethues and Vault are all examples of technologies we will be using in our cluster and are deployed using <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/operator/ >Kubernetes Operators</a>. In this section we'll be deploying the <a href=https://rook.io>Rook</a> storage orchestrator with <a href=http://ceph.com>Ceph</a> as a storage provider. </p> <h3 id=components>Components</h3> <h4 id=rook>Rook</h4> <p><a href=https://rook.io>Rook</a> allows us to use storage systems in a cloud-agnostic way and replicate the feel of a public cloud where you attach a storage volume to a container for application data persistence (e.g. EBS on AWS). We're going to configure it to use Ceph as a storage provider.</p> <p>More information on the architecure can be found in the <a href=https://rook.github.io/docs/rook/master/ceph-storage.html>docs</a></p> <p><img alt="Rook Architecture" src=https://rook.github.io/docs/rook/master/media/rook-architecture.png></p> <p><img alt="Rook Kubernetes" src=https://rook.github.io/docs/rook/master/media/kubernetes.png></p> <h4 id=ceph>Ceph</h4> <p>Ceph provides three types of storage:</p> <ul> <li><code>object</code>: compatible with S3 API</li> <li><code>file</code>: files and directories (incl. NFS); and</li> <li><code>block</code>: replicate a hard drive</li> </ul> <p>There a 4 key components of the architecture to be aware of (shown above in the Rook diagram):</p> <ul> <li><code>Monitor</code> (min 3): keeps a map of state in cluster for components to communicate with each other and handles authentication</li> <li><code>Manager</code> daemon: keeps track of state in cluster and metrics</li> <li><code>OSDs</code> (Object Storage daemon, min 3): stores the data. These will run on multiple nodes and handle the read/write operations to their underlying storage.</li> <li><code>MSDs</code> (Metatdata Server): concerned with filesystem storage type only</li> </ul> <p>Under the hood everything is stored as an object in logical storage pools.</p> <h3 id=installation-and-setup>Installation and Setup</h3> <h4 id=deployment-of-the-rook-operator>Deployment of the Rook operator</h4> <p>See the Rook <a href=https://rook.io/docs/rook/v1.1/ceph-quickstart.html>quickstart</a></p> <p>We're going to download some sample files from the main repo and make a tweak so that we can deploy multiple <code>mon</code> components onto a single node. Similar to when we <a href=../../02.kubernetes/00.configuring.kubernetes/#remove-the-control-plane-node-isolation-taint>removed the the control plane node taint</a> Ceph will fail to run otherwise (as it wants a quorum of mons across multiple nodes).</p> <div class=highlight><pre><span></span><span class=c1># create a working directory</span>
mkdir -p ~/rook <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>cd</span> ~/rook

<span class=c1># download the sample files</span>
<span class=c1># all of these can be found here: https://github.com/rook/rook/tree/release-1.1/cluster/examples/kubernetes/ceph</span>
wget https://raw.githubusercontent.com/rook/rook/release-1.1/cluster/examples/kubernetes/ceph/common.yaml<span class=p>;</span> <span class=se>\</span>
wget https://raw.githubusercontent.com/rook/rook/release-1.1/cluster/examples/kubernetes/ceph/operator.yaml<span class=p>;</span> <span class=se>\</span>
wget https://raw.githubusercontent.com/rook/rook/release-1.1/cluster/examples/kubernetes/ceph/cluster.yaml<span class=p>;</span> <span class=se>\</span>
wget https://raw.githubusercontent.com/rook/rook/release-1.1/cluster/examples/kubernetes/ceph/toolbox.yaml

<span class=c1># modify the cluster spec</span>
<span class=c1>#   - allow multiple mons per node</span>
sed -i.bak <span class=s1>&#39;s/allowMultiplePerNode: false/allowMultiplePerNode: true/&#39;</span> cluster.yaml
</pre></div> <p>In addition, because we've setup our encrypted data storage to be mounted at <code>/data/${BLKID}</code> we will edit the default storage options to remove the <code>useAllDevices</code> selection and, instead, specify the directories. See the <a href=https://rook.io/docs/rook/v1.1/ceph-cluster-crd.html#storage-configuration-cluster-wide-directories>docs</a> for more details.</p> <div class=highlight><pre><span></span><span class=c1># set default storage location and remove default `useAllDevices: true`</span>
sed -i.bak <span class=s1>&#39;s/useAllDevices: true/useAllDevices: false/&#39;</span> cluster.yaml
<span class=c1># any devices starting with &#39;sd&#39; (but not sda as that&#39;s our root filesystem)</span>
sed -i.bak <span class=s1>&#39;s/deviceFilter:/deviceFilter: ^sd[^a]/&#39;</span> cluster.yaml
<span class=c1># encrypt them with LUKS</span>
<span class=c1># see conversation https://github.com/rook/rook/issues/923#issuecomment-557651052</span>
sed -i.bak <span class=s1>&#39;s/# encryptedDevice: &quot;true&quot;/encryptedDevice: &quot;true&quot;/&#39;</span> cluster.yaml
</pre></div> <details class=tip open=open><summary>Wiping disks for usage</summary><p>Because Rook will fail if it finds an existing "in use" filesystem or disk we need to wipe the disks in the host which we want to use.</p> <p>For example. In use disks below (from a previous cluster).</p> <details class=info><summary>in use</summary><div class=highlight><pre><span></span>$ lsblk

NAME                                                                                                 MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
loop0                                                                                                  <span class=m>7</span>:0    <span class=m>0</span>  <span class=m>88</span>.5M  <span class=m>1</span> loop /snap/core/7270
sda                                                                                                    <span class=m>8</span>:0    <span class=m>0</span> <span class=m>111</span>.3G  <span class=m>0</span> disk 
├─sda1                                                                                                 <span class=m>8</span>:1    <span class=m>0</span>     1M  <span class=m>0</span> part 
└─sda2                                                                                                 <span class=m>8</span>:2    <span class=m>0</span> <span class=m>111</span>.3G  <span class=m>0</span> part /
sdb                                                                                                    <span class=m>8</span>:16   <span class=m>0</span>   <span class=m>1</span>.8T  <span class=m>0</span> disk 
└─ceph--04176411--2495--4944--abae--4ac6cedd8b46-osd--data--20a17864--c8d4--48f7--8aa0--e9d393fbb9e4 <span class=m>253</span>:1    <span class=m>0</span>   <span class=m>1</span>.8T  <span class=m>0</span> lvm  
sdc                                                                                                    <span class=m>8</span>:32   <span class=m>0</span>   <span class=m>1</span>.8T  <span class=m>0</span> disk 
└─ceph--38ed1893--7746--477a--a8c8--dae66f8360e5-osd--data--0940f2cf--d1c2--489f--9c8a--31d75d759be8 <span class=m>253</span>:0    <span class=m>0</span>   <span class=m>1</span>.8T  <span class=m>0</span> lvm  
sdd                                                                                                    <span class=m>8</span>:48   <span class=m>0</span>     2T  <span class=m>0</span> disk 
sde                                                                                                    <span class=m>8</span>:64   <span class=m>0</span>     2T  <span class=m>0</span> disk 
sr0                                                                                                   <span class=m>11</span>:0    <span class=m>1</span>  1024M  <span class=m>0</span> rom 
</pre></div> </details> <p>We can delete and wipe the disk of partition maps. <div class=highlight><pre><span></span><span class=c1># replicate the rook commands (and use regex to exclude sda like the manifest)</span>
<span class=nb>export</span> <span class=nv>DISKS</span><span class=o>=</span><span class=k>$(</span>lsblk --all --noheadings --list --output KNAME <span class=p>|</span> grep sd<span class=o>[</span>^a<span class=o>]</span><span class=k>)</span><span class=p>;</span> <span class=se>\</span>
<span class=k>for</span> d in <span class=nv>$DISKS</span><span class=p>;</span> <span class=k>do</span> <span class=se>\</span>
    <span class=nb>export</span> <span class=nv>DISK</span><span class=o>=</span>/dev/<span class=nv>$d</span><span class=p>;</span> <span class=se>\</span>
    sudo wipefs <span class=nv>$DISK</span><span class=p>;</span> <span class=se>\</span>
    sudo vgremove -y <span class=k>$(</span>sudo pvscan <span class=p>|</span> grep <span class=nv>$DISK</span> <span class=p>|</span> awk <span class=s1>&#39;{print $4}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=se>\</span>
    sudo dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span><span class=nv>$DISK</span> <span class=nv>bs</span><span class=o>=</span><span class=m>512</span> <span class=nv>count</span><span class=o>=</span><span class=m>10</span><span class=p>;</span> <span class=se>\</span>
<span class=k>done</span>
</pre></div></p> <p>Now, if appropriate, remove the LVM with the appropriate combination of <code>pvremove</code>, <code>lvremove</code>, <code>vgremove</code> etc. <div class=highlight><pre><span></span>$ sudo vgremove -y <span class=k>$(</span>sudo pvscan <span class=p>|</span> grep <span class=nv>$DISK</span> <span class=p>|</span> awk <span class=s1>&#39;{print $4}&#39;</span><span class=k>)</span>

Logical volume <span class=s2>&quot;osd-data-20a17864-c8d4-48f7-8aa0-e9d393fbb9e4&quot;</span> successfully removed
Volume group <span class=s2>&quot;ceph-04176411-2495-4944-abae-4ac6cedd8b46&quot;</span> successfully removed
</pre></div></p> </details> <p>With these configurations now downloaded we'll apply them in the following order.</p> <div class=highlight><pre><span></span>kubectl create -f ~/rook/common.yaml<span class=p>;</span> <span class=se>\</span>
kubectl create -f ~/rook/operator.yaml
</pre></div> <details class=warning open=open><summary>Verify the <code>rook-ceph-operator</code> is in the <code>Running</code> state</summary><p>Use <code>kubectl -n rook-ceph get pod</code> to check we have a running state. <div class=highlight><pre><span></span>root@banks:~# kubectl -n rook-ceph get pod
NAME                                            READY   STATUS    RESTARTS   AGE
...
rook-ceph-operator-c8ff6447d-tbh5c              <span class=m>1</span>/1     Running   <span class=m>0</span>          6m18s
</pre></div></p> </details> <h4 id=create-the-rook-cluster>Create the Rook cluster</h4> <p>Assuming the operator looks ok we can now create the cluster <div class=highlight><pre><span></span>kubectl create -f ~/rook/cluster.yaml
</pre></div></p> <p>To verify the state of the cluster we will connect to the <a href=https://rook.io/docs/rook/v1.1/ceph-toolbox.html>Rook Toolbox</a></p> <div class=highlight><pre><span></span>kubectl create -f ~/rook/toolbox.yaml
</pre></div> <p>Wait for the toolbox pod to enter a <code>running</code> state:</p> <div class=highlight><pre><span></span>kubectl -n rook-ceph get pod -l <span class=s2>&quot;app=rook-ceph-tools&quot;</span>
</pre></div> <p>Once the rook-ceph-tools pod is running, you can connect to it with: <div class=highlight><pre><span></span>kubectl -n rook-ceph <span class=nb>exec</span> -it <span class=k>$(</span>kubectl -n rook-ceph get pod -l <span class=s2>&quot;app=rook-ceph-tools&quot;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].metadata.name}&#39;</span><span class=k>)</span> bash
</pre></div></p> <p>When inside the toolbox run <code>ceph status</code> after setting a custom prompt so we don't forget where we are.</p> <div class=highlight><pre><span></span><span class=nb>export</span> <span class=nv>PS1</span><span class=o>=</span><span class=s2>&quot;ceph-toolbox# &quot;</span>
</pre></div> <details class=info open=open><summary>ceph status</summary><div class=highlight><pre><span></span><span class=o>[</span>root@banks /<span class=o>]</span><span class=c1># ceph status</span>
cluster:
    id:     06da5ebc-d2f3-4366-a51c-db759d8bc664
    health: HEALTH_OK

services:
    mon: <span class=m>3</span> daemons, quorum a,b,c <span class=o>(</span>age 2m<span class=o>)</span>
    mgr: a<span class=o>(</span>active, since 102s<span class=o>)</span>
    osd: <span class=m>2</span> osds: <span class=m>2</span> up <span class=o>(</span>since 33s<span class=o>)</span>, <span class=m>2</span> in <span class=o>(</span>since 33s<span class=o>)</span>

data:
    pools:   <span class=m>0</span> pools, <span class=m>0</span> pgs
    objects: <span class=m>0</span> objects, <span class=m>0</span> B
    usage:   <span class=m>2</span>.0 GiB used, <span class=m>3</span>.6 TiB / <span class=m>3</span>.6 TiB avail
    pgs:         
</pre></div> <ul> <li>All mons should be in quorum</li> <li>A mgr should be active</li> <li>At least one OSD should be active</li> <li>If the health is not HEALTH_OK, the warnings or errors should be investigated</li> </ul> <h5 id=toubleshooting-not-all-osds-disks-are-created>Toubleshooting: Not all OSDs (disks) are created</h5> <p>The task to prepare a disk can vary in duration based on it's size and a number of other factors. Start off by checking that the <code>prepare</code> has actually finished.</p> <div class=highlight><pre><span></span>$ watch kubectl -n rook-ceph get pod -l app=rook-ceph-osd-prepare

NAME                                      READY   STATUS      RESTARTS   AGE
rook-ceph-osd-prepare-banks.local-dlvk7   0/1     Completed   0          2m31s
</pre></div> <p>If this doesn't show <code>Completed</code> then it's still performing the tasks. Wait for it to complete and then go back into the toolbox and check the <code>ceph status</code> output again.</p> <h5 id=troubleshooting-errno-2>Troubleshooting: [errno 2]</h5> <p><strong>NB:</strong> You might get an error <code>unable to get monitor info from DNS SRV with service name: ceph-mon</code> or <code>[errno 2] error connecting to the cluster</code> when running <code>ceph status</code> in the toolbox if you've typed all of the above commands very quickly. This is usually because the cluster is still starting and waiting for all the monitors to come up and establish connections. Go get a cup of tea / wait a couple of minutes and try again.</p> <p>In the <code>cluster.yaml</code> spec the default number of <code>mon</code> instances is <code>3</code>. As a result if you don't have three of these pods running then your cluster is still initialising. You can run <code>kubectl -n rook-ceph logs -l "app=rook-ceph-operator"</code> to see an output of the logs from the operator and search for <code>mons running</code>. As you can see below it took mine around a minute to initialise all 3. To see what monitors you have run <code>kubectl -n rook-ceph get pod -l "app=rook-ceph-mon"</code>.</p> <div class=highlight><pre><span></span>$ kubectl -n rook-ceph get pod -l <span class=s2>&quot;app=rook-ceph-mon&quot;</span>
NAME                               READY   STATUS    RESTARTS   AGE
<span class=hll>rook-ceph-mon-a-5d677b5849-t4xct   <span class=m>1</span>/1     Running   <span class=m>0</span>          82s
</span>rook-ceph-mon-b-6cfbcf8db4-7cwxp   <span class=m>1</span>/1     Running   <span class=m>0</span>          66s
<span class=hll>rook-ceph-mon-c-8f858c585-c9z5b    <span class=m>1</span>/1     Running   <span class=m>0</span>          50s
</span></pre></div> </details> <p>When you are done with the toolbox, you can remove the deployment: <div class=highlight><pre><span></span>kubectl -n rook-ceph delete deployment rook-ceph-tools
</pre></div></p> <details class=tip><summary>If you want to delete the cluster and start again...</summary><p>Obviously everything worked first time... But, if it didn't, you can always delete everything and start again with the following commands. Essentially undoing what we applied in the yaml configs earlier in reverse. There are some additional pointers <a href=https://rook.io/docs/rook/master/ceph-teardown.html>here</a> in the docs. <div class=highlight><pre><span></span>kubectl delete -f toolbox.yaml<span class=p>;</span> <span class=se>\</span>
kubectl delete -f cluster.yaml<span class=p>;</span> <span class=se>\</span>
kubectl delete -f operator.yaml<span class=p>;</span> <span class=se>\</span>
kubectl delete -f common.yaml<span class=p>;</span> <span class=se>\</span>
rm -rf ~/rook<span class=p>;</span> <span class=se>\</span>
sudo rm -rf /var/lib/rook/*
</pre></div></p> </details> <h3 id=dashboard-and-storage>Dashboard and Storage</h3> <p>We now have a cluster running but no configured storage or an ability to review status (other than logging into the toolbox).</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../../03.certificates/00.cert.manager/ title="TLS Certificates Management" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> TLS Certificates Management </span> </div> </a> <a href=../01.dashboard/ title="Setup Dashboard" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Setup Dashboard </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight id=copy> <!-- &copy Darth Veitcher 2019-&date --> </div> <script type=text/javascript>
            let theDate=new Date();
            copy.innerHTML = "&copy Darth Veitcher "+theDate.getFullYear();
        </script> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/darth-veitcher class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>