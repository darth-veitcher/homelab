<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An overkill homelab setup"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Storage (Clarke) - Homelab</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CHackman&display=fallback"><style>body,input{font-family:"","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hackman","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=teal> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#specs tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=../../.. title=Homelab class="md-header-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Homelab </span> <span class=md-header-nav__topic> Storage (Clarke) </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=../../.. title=Homelab class="md-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> Homelab </label> <div class=md-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Introduction class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Infrastructure </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../00.configuring.physical.nodes/ title="Host Configuration" class=md-nav__link> Host Configuration </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2 checked> <label class=md-nav__link for=nav-2-2> Hosts </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Hosts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-1 type=checkbox id=nav-2-2-1 checked> <label class=md-nav__link for=nav-2-2-1> On-prem </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-1> On-prem </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../01.banks/ title="Compute (Banks)" class=md-nav__link> Compute (Banks) </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Storage (Clarke) </label> <a href=./ title="Storage (Clarke)" class="md-nav__link md-nav__link--active"> Storage (Clarke) </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#specs class=md-nav__link> Specs </a> </li> <li class=md-nav__item> <a href=#setup-storage class=md-nav__link> Setup storage </a> </li> <li class=md-nav__item> <a href=#create-a-keyfile class=md-nav__link> Create a KeyFile </a> </li> <li class=md-nav__item> <a href=#configure-disks class=md-nav__link> Configure disks </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#encrypt-with-luks class=md-nav__link> Encrypt with LUKS </a> </li> <li class=md-nav__item> <a href=#auto-mount-encrypted-devices-at-boot class=md-nav__link> Auto-mount encrypted devices at boot </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-a-usb-as-a-keyfile class=md-nav__link> Using a USB as a KeyFile </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#completing class=md-nav__link> Completing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> Networking </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-2 type=checkbox id=nav-2-2-2> <label class=md-nav__link for=nav-2-2-2> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-2> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../03.donaldson/ title="Compute (Donaldson)" class=md-nav__link> Compute (Donaldson) </a> </li> <li class=md-nav__item> <a href=../04.hamilton/ title="Ingress (Hamilton)" class=md-nav__link> Ingress (Hamilton) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Kubernetes Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Kubernetes Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02.kubernetes/00.configuring.kubernetes/ title="Install Kubernetes" class=md-nav__link> Install Kubernetes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2> <label class=md-nav__link for=nav-2-3-2> Initial Networking </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-2> Initial Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02.kubernetes/01.cni/ title=CNI class=md-nav__link> CNI </a> </li> <li class=md-nav__item> <a href=../../02.kubernetes/02.metallb/ title="Load Balancer" class=md-nav__link> Load Balancer </a> </li> <li class=md-nav__item> <a href=../../02.kubernetes/03.ingress/ title=Ingress class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../03.certificates/00.cert.manager/ title="TLS Certificates Management" class=md-nav__link> TLS Certificates Management </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> CEPH Storage with Rook </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> CEPH Storage with Rook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../04.storage/00.setup.ceph.storage.with.rook/ title="Install the Cluster" class=md-nav__link> Install the Cluster </a> </li> <li class=md-nav__item> <a href=../../04.storage/01.dashboard/ title="Setup Dashboard" class=md-nav__link> Setup Dashboard </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5-3 type=checkbox id=nav-2-5-3> <label class=md-nav__link for=nav-2-5-3> Storage Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-5-3> Storage Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../04.storage/02.storage/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../04.storage/0200.block/ title=Block class=md-nav__link> Block </a> </li> <li class=md-nav__item> <a href=../../04.storage/0201.filesystem/ title=Filesystem class=md-nav__link> Filesystem </a> </li> <li class=md-nav__item> <a href=../../04.storage/0202.object/ title=Object class=md-nav__link> Object </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-6 type=checkbox id=nav-2-6> <label class=md-nav__link for=nav-2-6> Monitoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-6> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../05.monitoring/00.monitoring.with.prometheus.and.grafana/ title="Prometheus and Grafana" class=md-nav__link> Prometheus and Grafana </a> </li> <li class=md-nav__item> <a href=../../05.monitoring/01.kubernetes.dashboard/ title="Kubernetes Dashboard" class=md-nav__link> Kubernetes Dashboard </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Identity and Access Management (IDAM) </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Identity and Access Management (IDAM) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../02.idam/00.idam/ title="IDAM Overview" class=md-nav__link> IDAM Overview </a> </li> <li class=md-nav__item> <a href=../../../02.idam/01.openldap/ title=OpenLDAP class=md-nav__link> OpenLDAP </a> </li> <li class=md-nav__item> <a href=../../../02.idam/02.keycloak/ title=Keycloak class=md-nav__link> Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Integration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../02.idam/03.integration/00.integration/ title=Overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../02.idam/03.integration/01.kubernetes/ title="Kubernetes (API)" class=md-nav__link> Kubernetes (API) </a> </li> <li class=md-nav__item> <a href=../../../02.idam/03.integration/02.kubernetes.dashboard/ title="Kubernetes (Dashboard)" class=md-nav__link> Kubernetes (Dashboard) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Snippets </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Snippets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../99.snippets/storage.disks/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../../99.snippets/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../99.snippets/ceph/ title=Ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#specs class=md-nav__link> Specs </a> </li> <li class=md-nav__item> <a href=#setup-storage class=md-nav__link> Setup storage </a> </li> <li class=md-nav__item> <a href=#create-a-keyfile class=md-nav__link> Create a KeyFile </a> </li> <li class=md-nav__item> <a href=#configure-disks class=md-nav__link> Configure disks </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#encrypt-with-luks class=md-nav__link> Encrypt with LUKS </a> </li> <li class=md-nav__item> <a href=#auto-mount-encrypted-devices-at-boot class=md-nav__link> Auto-mount encrypted devices at boot </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-a-usb-as-a-keyfile class=md-nav__link> Using a USB as a KeyFile </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#completing class=md-nav__link> Completing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#networking class=md-nav__link> Networking </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/darth-veitcher/homelab/edit/master/docs/01.infrastructure/01.hosts/02.clarke.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>Storage (Clarke)</h1> <p>I've got an old self-built frankenstein storage server that runs a <strong>lot</strong> of disks in it. Again, I've installed Ubuntu 18.04 LTS on it and will add as a master node to the cluster to surface up file/block/object storage to workloads.</p> <p><strong>NB:</strong> I'm going to use the storage server as a master due to the fact it's one of the device which <em>should</em> always be on and running to support other workloads.</p> <h4 id=specs>Specs</h4> <p>For reference, here's the specs and parts list.</p> <h3 id=setup-storage>Setup storage</h3> <p>As I'll be using <a href=https://ceph.com>Ceph</a> I'll leave all the disks as standalone JBOD (**J**ust a **B**unch **O**f **D**isks, no RAID) and perform fulldisk encryption such that they have to be unlocked if removed from the server with a key that's held on a separate, removeable, usb stick.</p> <p>Finding the relevant disks is done with <code>lsblk</code>.</p> <details class=info><summary>example lsblk</summary></details> <p>I've expanded the <code>lsblk</code> command below to add some additional output options to help.</p> <ul> <li><code>serial</code>: disk serial number (can be found on the physical disk)</li> <li><code>kname</code>: internal kernel device name</li> <li><code>wwn</code>: unique storage identifier (can be found on the physical disk, seems like not universally implemented by manufacturers)</li> <li><code>hotplug</code>: removable or hotplug device (usb, pcmcia, ...)</li> <li><code>rota</code>: rotational device (i.e. is it spinning rust <code>hdd</code> or <code>ssd</code>|<code>nvme</code>)</li> </ul> <div class=highlight><pre><span></span>$ lsblk -o +size,serial,kname,wwn,hotplug,rota

NAME                  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT   SIZE SERIAL               KNAME     WWN                  HOTPLUG ROTA
sda                     <span class=m>8</span>:0    <span class=m>0</span>   <span class=m>2</span>.7T  <span class=m>0</span> disk              <span class=m>2</span>.7T WD-WMC4N0K53DHU      sda       0x50014ee6b0533e3d         <span class=m>0</span>    <span class=m>1</span>
sdb                     <span class=m>8</span>:16   <span class=m>0</span> <span class=m>953</span>.9G  <span class=m>0</span> disk            <span class=m>953</span>.9G <span class=m>9591205808031</span>        sdb                                  <span class=m>0</span>    <span class=m>0</span>
sdc                     <span class=m>8</span>:32   <span class=m>0</span> <span class=m>117</span>.4G  <span class=m>0</span> disk            <span class=m>117</span>.4G <span class=m>142433405344</span>         sdc       0x5001b44c354645a0         <span class=m>0</span>    <span class=m>0</span>
sdd                     <span class=m>8</span>:48   <span class=m>0</span> <span class=m>953</span>.9G  <span class=m>0</span> disk            <span class=m>953</span>.9G <span class=m>9591205808034</span>        sdd                                  <span class=m>0</span>    <span class=m>0</span>
sde                     <span class=m>8</span>:64   <span class=m>0</span>   <span class=m>2</span>.7T  <span class=m>0</span> disk              <span class=m>2</span>.7T WD-WCC4N6APEFS4      sde       0x50014ee2605ef68e         <span class=m>0</span>    <span class=m>1</span>
sdf                     <span class=m>8</span>:80   <span class=m>1</span>  <span class=m>29</span>.3G  <span class=m>0</span> disk             <span class=m>29</span>.3G 4C530000290829118252 sdf                                  <span class=m>1</span>    <span class=m>1</span>
└─sdf1                  <span class=m>8</span>:81   <span class=m>1</span>  <span class=m>29</span>.3G  <span class=m>0</span> part /mnt/key    <span class=m>29</span>.3G                      sdf1                                 <span class=m>1</span>    <span class=m>1</span>
nvme0n1               <span class=m>259</span>:0    <span class=m>0</span> <span class=m>119</span>.2G  <span class=m>0</span> disk            <span class=m>119</span>.2G <span class=m>9191210606695</span>        nvme0n1   eui.0100000000000000       <span class=m>0</span>    <span class=m>0</span>
├─nvme0n1p1           <span class=m>259</span>:1    <span class=m>0</span>   512M  <span class=m>0</span> part /boot/efi    512M                      nvme0n1p1 eui.0100000000000000       <span class=m>0</span>    <span class=m>0</span>
└─nvme0n1p2           <span class=m>259</span>:2    <span class=m>0</span> <span class=m>118</span>.8G  <span class=m>0</span> part            <span class=m>118</span>.8G                      nvme0n1p2 eui.0100000000000000       <span class=m>0</span>    <span class=m>0</span>
  ├─clarke--vg-root   <span class=m>253</span>:0    <span class=m>0</span> <span class=m>117</span>.8G  <span class=m>0</span> lvm  /          <span class=m>117</span>.8G                      dm-0                                 <span class=m>0</span>    <span class=m>0</span>
  └─clarke--vg-swap_1 <span class=m>253</span>:1    <span class=m>0</span>   980M  <span class=m>0</span> lvm               980M                      dm-1                                 <span class=m>0</span>    <span class=m>0</span>
</pre></div> <p>Based on the above output we can see I have:</p> <ul> <li>one <code>hotplug</code> device (<code>sdf</code>) which is the usb with the key on it, mounted to <code>/mnt/key</code></li> <li>two <code>rotational</code> devices (<code>sde</code>, <code>sda</code>) with 2.7TB of capacity</li> <li>three <code>non-rotational</code> (i.e. <code>ssd</code>) devices with varying capacities (<code>sdb</code>, <code>sdc</code>, <code>sdd</code>)</li> <li>one device (<code>nvme</code>) which contains the OS</li> </ul> <p>As a way of illustration her are pictures of the physcial devices in <code>sda</code> and <code>sdb</code>.</p> <p>??? example "<code>sda</code> 3TB Western Digital Green <a href=../img/IMG_0463.jpg>!WD</a></p> <p>??? example "<code>sdb</code> KingSpec 1TB SSD <a href=../img/IMG_0472.jpg>!KS</a></p> <h3 id=create-a-keyfile>Create a KeyFile</h3> <p>There a a number of different ways to do this. I'd also advise that you perform this on your trusted development machine (and back up the resulting file somewhere...) as opposed to doing all of this on the target host.</p> <div class=highlight><pre><span></span><span class=c1># Create a keyfile (for automounting when plugged in)</span>
<span class=c1># This will take a number of minutes...</span>
dd <span class=k>if</span><span class=o>=</span>/dev/random <span class=nv>of</span><span class=o>=</span>~/.secretkey <span class=nv>bs</span><span class=o>=</span><span class=m>1</span> <span class=nv>count</span><span class=o>=</span><span class=m>4096</span>
chmod <span class=m>0400</span> ~/.secretkey
</pre></div> <p>Copy that file onto a <code>FAT</code> formatted USB drive. It probably doesn't matter too much what filesystem you use but that has the most common support across Linux, MacOS and Windows.</p> <p>Now, in the target host, insert the USB and mount it to <code>/mnt/key</code> as <code>read only</code>.</p> <div class=highlight><pre><span></span>sudo mkdir -p /mnt/key
sudo mount -t vfat -o defaults,ro /dev/sdf1 /mnt/key
</pre></div> <p>Check this has worked by listing the contents and then attempting to modify the keyfile.</p> <div class=highlight><pre><span></span>$ head -n <span class=m>1</span> /mnt/key/.secretkey 

M???j<span class=o>[</span>̵s?%?&lt;<span class=p>;</span>?fwefwehwqn??pZ?^o?v?<span class=p>|</span><span class=m>2</span>?fǄ<span class=o>)</span>?#?%??x*?@.??
??j????/?2?NC?<span class=o>]</span>?<span class=o>{</span>?<span class=o>}</span>thmrtj675?i??CZ<span class=p>&amp;</span>???S?t324t?X?:?R?*?fl98??g?qxcv?n6?loi0<span class=p>;</span>?

$ <span class=nb>echo</span> <span class=s1>&#39;test modify&#39;</span> &gt;&gt; /mnt/key/.secretkey

-bash: /mnt/key/.secretkey: Read-only file system
</pre></div> <p>Make this persist across reboots by modifying <code>fstab</code>. Replace the UUID with the output from <code>blkid</code>.</p> <div class=highlight><pre><span></span><span class=c1># Get the UUID of disk</span>
$ blkid /dev/sdf1 -o value -s UUID

FFCA-07F9
</pre></div> <p>Now add into fstab so it's mounted every boot.</p> <div class=highlight><pre><span></span><span class=c1># file: /etc/fstab</span>
<span class=c1># Key</span>
<span class=nv>UUID</span><span class=o>=</span>FFCA-07F9    /mnt/key    vfat    defaults,ro    <span class=m>0</span>    <span class=m>1</span>
</pre></div> <h3 id=configure-disks>Configure disks</h3> <p>Rook and Ceph ideally work with blank disks and then take over the management of them, filesystem etc. Whilst we <em>could</em> allow Ceph to perform the encryption of the devices automatically I'd like to manage that myself with the physcial key. As a result we'll use <code>cryptsetup</code> first on our disks to create a <code>LUKS</code> volume that we then later provide to Ceph as the target device using a recent patch for <code>devicePathFilter</code> in Rook.</p> <p><strong>NB:</strong> There's a <a href>script</a> which will do this in an automated fashion in the files section of the repo. The below just covers it in order to explain the steps and process.</p> <h4 id=encrypt-with-luks>Encrypt with LUKS</h4> <div class=highlight><pre><span></span><span class=c1># Set the disk</span>
<span class=nb>export</span> <span class=nv>d</span><span class=o>=</span>sdb
<span class=nb>export</span> <span class=nv>DISK</span><span class=o>=</span>/dev/<span class=si>${</span><span class=nv>d</span><span class=si>}</span>

<span class=c1># Reset the disk</span>
sudo wipefs -af /dev/<span class=nv>$d</span>

<span class=c1># Encrypt the whole disk (using the keyfile)</span>
sudo cryptsetup luksFormat -q -s <span class=m>512</span> -c aes-xts-plain64 -d /mnt/key/.secretkey /dev/<span class=nv>$d</span>
</pre></div> <h4 id=auto-mount-encrypted-devices-at-boot>Auto-mount encrypted devices at boot</h4> <p>We'll now configure the system to automatically unlock the encrypted partitions on boot. Edit the <code>/etc/crypttab</code> file to provide the nexessary information. For that we'll need the <code>UUID</code> for each block device which can be found from the <code>blkid</code> command. For more details on the principles and processes behind the below see the excellent <a href=https://wiki.archlinux.org/index.php/Dm-crypt/System_configuration#crypttab>Arch Wiki</a>.</p> <blockquote> <p>The <code>/etc/crypttab</code> (encrypted device table) file is similar to the <code>fstab</code> file and contains a list of encrypted devices to be unlocked during system boot up. This file can be used for automatically mounting encrypted swap devices or secondary file systems.</p> <p><code>crypttab</code> is read before <code>fstab</code>, so that <code>dm-crypt</code> containers can be unlocked before the file system inside is mounted.</p> </blockquote> <div class=highlight><pre><span></span><span class=c1># Get the blkid of the encrypted disk</span>
<span class=nb>export</span> <span class=nv>d</span><span class=o>=</span>sdb
<span class=nb>export</span> <span class=nv>DISK</span><span class=o>=</span>/dev/<span class=si>${</span><span class=nv>d</span><span class=si>}</span>
<span class=nb>export</span> <span class=nv>BLKID</span><span class=o>=</span><span class=k>$(</span>blkid -s UUID -o value /dev/<span class=nv>$d</span><span class=k>)</span>

<span class=c1># Now edit the crypttab</span>
<span class=c1># file: /etc/crypttab</span>
<span class=c1># Fields are: name, underlying device, passphrase, cryptsetup options.</span>
<span class=c1># The below mounts the device with UUID into /dev/mapper/data-&lt;uuid&gt; and unlocks using the secretkey</span>
sudo tee -a /etc/crypttab <span class=s>&lt;&lt;EOF</span>
<span class=s>  data-${BLKID}  UUID=${BLKID}    /mnt/key/.secretkey    luks,retry=1,timeout=180</span>
<span class=s>EOF</span>
</pre></div> <p>Whilst we could now add the decrypted <code>/dev/mapper/data-${BLKID}</code> into <code>fstab</code> and mount it somewhere we don't need to for Rook and Ceph, they'll take over from here.</p> <h5 id=using-a-usb-as-a-keyfile>Using a USB as a KeyFile</h5> <p>As detailed <a href=https://willhaley.com/blog/unlock-luks-volumes-with-usb-key/ >Unlock LUKS Encrypted Volumes at Boot With a USB Key</a></p> <blockquote> <p>There is a bit of a catch here. <code>/etc/crypttab</code> is processed before <code>/etc/fstab</code>. So <code>/mnt/key</code> will not be available at the right time.</p> </blockquote> <p>What we need to do is create a <code>/etc/default/cryptdisks</code> file with the associated mount that needs to be present before processing <code>/etc/crypttab</code>.</p> <div class=highlight><pre><span></span>sudo tee -a /etc/default/cryptdisks <span class=s>&lt;&lt;EOF</span>
<span class=s>  CRYPTDISKS_MOUNT=&#39;/mnt/key&#39;</span>
<span class=s>EOF</span>
</pre></div> <h4 id=completing>Completing</h4> <p>To confirm the above is all working run a <code>sudo shutdown -r now</code> in order to prove the devices are decrypted by the key successfully.</p> <h3 id=networking>Networking</h3> <p>As I'm using a switch that supports <a href=https://en.wikipedia.org/wiki/Link_aggregation>link aggregation (LACP)</a> and a server with multiple network interface controllers (NICs) I'll modify the network configuration to take advantage of this.</p> <p>Create the file <code>/etc/netplan/config.yaml</code> with the following in it and then apply the configuration with <code>sudo netplan apply</code>, followed by a reboot. Modify as necessary for your setup.</p> <div class=highlight><pre><span></span><span class=c1># /etc/netplan/config.yaml</span>
<span class=c1># sudo netplan apply</span>
<span class=nt>network</span><span class=p>:</span>
  <span class=nt>version</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class=nt>ethernets</span><span class=p>:</span>
    <span class=nt>eports</span><span class=p>:</span>
      <span class=nt>match</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">enp*</span>
      <span class=nt>optional</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class=nt>bonds</span><span class=p>:</span>
    <span class=nt>bond0</span><span class=p>:</span>
      <span class=nt>dhcp4</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class=nt>interfaces</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=nv>eports</span><span class="p p-Indicator">]</span>
      <span class=c1># addresses: [192.168.0.111/24]</span>
      <span class=c1># gateway4: 192.168.0.1</span>
      <span class=c1># nameservers:</span>
      <span class=c1>#   search: [local]</span>
      <span class=c1>#   addresses: [8.8.8.8, 8.8.4.4]</span>
      <span class=nt>parameters</span><span class=p>:</span>
        <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">802.3ad</span>
        <span class=nt>lacp-rate</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fast</span>
        <span class=nt>transmit-hash-policy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">layer2</span>
</pre></div> <details class=info open=open><summary>Testing network throughput</summary><p>Using <code>iperf3</code> you can test that this bonding is working as expected.</p> <ul> <li><strong>mini</strong>: MacMini, single NIC</li> <li><strong>asimov</strong>: Dell R710, 4xNICs</li> <li><strong>clarke</strong>: Storage Server, 5xNICs</li> </ul> <p>With transfers from <code>clarke</code> &rarr; <code>mini</code> we get the following:</p> <div class=highlight><pre><span></span><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bandwidth       Retr
<span class=o>[</span>  <span class=m>4</span><span class=o>]</span>   <span class=m>0</span>.00-10.00  sec   <span class=m>112</span> MBytes  <span class=m>94</span>.2 Mbits/sec   <span class=m>64</span>             sender
<span class=o>[</span>  <span class=m>4</span><span class=o>]</span>   <span class=m>0</span>.00-10.00  sec   <span class=m>112</span> MBytes  <span class=m>94</span>.1 Mbits/sec                  receiver
</pre></div> <p>With transfers between <code>clarke</code> &rarr; <code>asimov</code> we get a substantially higher throughput:</p> <div class=highlight><pre><span></span><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bandwidth       Retr
<span class=o>[</span>  <span class=m>4</span><span class=o>]</span>   <span class=m>0</span>.00-10.00  sec  <span class=m>1</span>.00 GBytes   <span class=m>862</span> Mbits/sec    <span class=m>0</span>             sender
<span class=o>[</span>  <span class=m>4</span><span class=o>]</span>   <span class=m>0</span>.00-10.00  sec  <span class=m>1</span>.00 GBytes   <span class=m>862</span> Mbits/sec                  receiver
</pre></div> </details> <p>Based on the above performance of <code>862 Mbits/sec</code> I'm more likely to get limited by Disk I/O now.</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../01.banks/ title="Compute (Banks)" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Compute (Banks) </span> </div> </a> <a href=../03.donaldson/ title="Compute (Donaldson)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Compute (Donaldson) </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight id=copy> <!-- &copy Darth Veitcher 2019-&date --> </div> <script type=text/javascript>
            let theDate=new Date();
            copy.innerHTML = "&copy Darth Veitcher "+theDate.getFullYear();
        </script> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/darth-veitcher class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>