<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An overkill homelab setup"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>OpenLDAP - Homelab</title><link rel=stylesheet href=../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CHackman&display=fallback"><style>body,input{font-family:"","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hackman","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=teal> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#set-secrets tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=../.. title=Homelab class="md-header-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Homelab </span> <span class=md-header-nav__topic> OpenLDAP </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=../.. title=Homelab class="md-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> Homelab </label> <div class=md-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Introduction class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Infrastructure </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/00.configuring.physical.nodes/ title="Host Configuration" class=md-nav__link> Host Configuration </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Hosts </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Hosts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-1 type=checkbox id=nav-2-2-1> <label class=md-nav__link for=nav-2-2-1> On-prem </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-1> On-prem </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/01.banks/ title="Compute (Banks)" class=md-nav__link> Compute (Banks) </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/02.clarke/ title="Storage (Clarke)" class=md-nav__link> Storage (Clarke) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-2 type=checkbox id=nav-2-2-2> <label class=md-nav__link for=nav-2-2-2> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-2> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/03.donaldson/ title="Compute (Donaldson)" class=md-nav__link> Compute (Donaldson) </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/04.hamilton/ title="Ingress (Hamilton)" class=md-nav__link> Ingress (Hamilton) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Kubernetes Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Kubernetes Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/00.configuring.kubernetes/ title="Install Kubernetes" class=md-nav__link> Install Kubernetes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2> <label class=md-nav__link for=nav-2-3-2> Initial Networking </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-2> Initial Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/01.cni/ title=CNI class=md-nav__link> CNI </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/02.metallb/ title="Load Balancer" class=md-nav__link> Load Balancer </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/03.ingress/ title=Ingress class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../01.infrastructure/03.certificates/00.cert.manager/ title="TLS Certificates Management" class=md-nav__link> TLS Certificates Management </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> CEPH Storage with Rook </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> CEPH Storage with Rook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/00.setup.ceph.storage.with.rook/ title="Install the Cluster" class=md-nav__link> Install the Cluster </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/01.dashboard/ title="Setup Dashboard" class=md-nav__link> Setup Dashboard </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5-3 type=checkbox id=nav-2-5-3> <label class=md-nav__link for=nav-2-5-3> Storage Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-5-3> Storage Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/02.storage/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/0200.block/ title=Block class=md-nav__link> Block </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/0201.filesystem/ title=Filesystem class=md-nav__link> Filesystem </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/0202.object/ title=Object class=md-nav__link> Object </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-6 type=checkbox id=nav-2-6> <label class=md-nav__link for=nav-2-6> Monitoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-6> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/05.monitoring/00.monitoring.with.prometheus.and.grafana/ title="Prometheus and Grafana" class=md-nav__link> Prometheus and Grafana </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/05.monitoring/01.kubernetes.dashboard/ title="Kubernetes Dashboard" class=md-nav__link> Kubernetes Dashboard </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> Identity and Access Management (IDAM) </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Identity and Access Management (IDAM) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../00.idam/ title="IDAM Overview" class=md-nav__link> IDAM Overview </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> OpenLDAP </label> <a href=./ title=OpenLDAP class="md-nav__link md-nav__link--active"> OpenLDAP </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#set-secrets class=md-nav__link> Set Secrets </a> </li> <li class=md-nav__item> <a href=#admin class=md-nav__link> Admin </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#additional-entries class=md-nav__link> Additional entries </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#export-configuration-as-ldif class=md-nav__link> Export configuration as LDIF </a> </li> <li class=md-nav__item> <a href=#seed-the-database-with-the-exported-ldif-or-your-own class=md-nav__link> Seed the database with the exported LDIF (or your own) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../02.keycloak/ title=Keycloak class=md-nav__link> Keycloak </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> Integration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../03.integration/00.integration/ title=Overview class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../03.integration/01.kubernetes/ title="Kubernetes (API)" class=md-nav__link> Kubernetes (API) </a> </li> <li class=md-nav__item> <a href=../03.integration/02.kubernetes.dashboard/ title="Kubernetes (Dashboard)" class=md-nav__link> Kubernetes (Dashboard) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Snippets </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Snippets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../99.snippets/storage.disks/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../99.snippets/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../99.snippets/ceph/ title=Ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#set-secrets class=md-nav__link> Set Secrets </a> </li> <li class=md-nav__item> <a href=#admin class=md-nav__link> Admin </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#additional-entries class=md-nav__link> Additional entries </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#export-configuration-as-ldif class=md-nav__link> Export configuration as LDIF </a> </li> <li class=md-nav__item> <a href=#seed-the-database-with-the-exported-ldif-or-your-own class=md-nav__link> Seed the database with the exported LDIF (or your own) </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/darth-veitcher/homelab/edit/master/docs/02.idam/01.openldap.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>OpenLDAP</h1> <p>We're going to follow a previous tutorial I wrote for setting up an initial OpenLDAP installation on a VM and then seed an initial admin user. Dockerising this is done now with the <code>osixia/openldap</code> base image which can be found on <a href=https://github.com/osixia/docker-openldap>GitHub</a>. </p> <div class=highlight><pre><span></span><span class=c1># Create our working folder</span>
mkdir -p ~/auth<span class=p>;</span> <span class=se>\</span>
<span class=nb>cd</span> ~/auth
</pre></div> <h3 id=set-secrets>Set Secrets</h3> <p>As we're going to have some username/password combinations defined for our authentication services (e.g. database users, root admin users for LDAP and Keycloak etc.) we should store these as <code>secrets</code> and then add them into the environment or configuration of the containers in the manifests as references (as opposed to being hardcoded).</p> <p>There's two options to initially generate and save these secrets. We'll specify to create them only in the <code>auth</code> namespace.</p> <div class=superfences-tabs> <input name=__tabs_1 type=radio id=__tab_1_0 checked=checked> <label for=__tab_1_0>Generic CLI</label> <div class=superfences-content><div class=highlight><pre><span></span>$ kubectl -n auth create secret generic ldap-user-creds <span class=se>\</span>
      --from-literal<span class=o>=</span><span class=nv>LDAP_ADMIN_PASSWORD</span><span class=o>=</span>admin <span class=se>\</span>
      --from-literal<span class=o>=</span><span class=nv>LDAP_CONFIG_PASSWORD</span><span class=o>=</span>config

secret/ldap-user-creds created
</pre></div></div> <input name=__tabs_1 type=radio id=__tab_1_1> <label for=__tab_1_1>Using Manifest</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=c1># We should `base64` encode the secrets first.</span>
$ <span class=nb>echo</span> -n <span class=s1>&#39;admin&#39;</span> <span class=p>|</span> base64

<span class=nv>YWRtaW4</span><span class=o>=</span>

$ <span class=nb>echo</span> -n <span class=s1>&#39;config&#39;</span> <span class=p>|</span> base64

Y29uZmln

---
<span class=c1># Now use these base64 secrets in the manifest</span>
---
<span class=c1># file: ~/auth/ldap-user-creds-secret.yaml</span>
apiVersion: v1
kind: Secret
metadata:
  name: ldap-user-creds
  namespace: auth
type: Opaque
data:
  LDAP_ADMIN_PASSWORD: <span class=nv>YWRtaW4</span><span class=o>=</span>
  LDAP_CONFIG_PASSWORD: Y29uZmln
</pre></div></div> </div> <p>For either of the above methods for storing the secret you then access the key,value combinations in the deployment manifest like follows:</p> <div class=superfences-tabs> <input name=__tabs_2 type=radio id=__tab_2_0 checked=checked> <label for=__tab_2_0>envFrom</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=nt>envFrom</span><span class=p>:</span>
  <span class=c1># Secrets</span>
  <span class="p p-Indicator">-</span> <span class=nt>secretRef</span><span class=p>:</span>
      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-user-creds</span>
  <span class=c1># Normal plaintext config</span>
  <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
</pre></div></div> <input name=__tabs_2 type=radio id=__tab_2_1> <label for=__tab_2_1>env</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=nt>env</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LDAP_ADMIN_PASSWORD</span>
    <span class=nt>valueFrom</span><span class=p>:</span>
      <span class=nt>secretKeyRef</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-user-creds</span>
        <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LDAP_CONFIG_PASSWORD</span>
    <span class=nt>valueFrom</span><span class=p>:</span>
      <span class=nt>secretKeyRef</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-user-creds</span>
        <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LDAP_CONFIG_PASSWORD</span>
</pre></div></div> </div> <details class=warning><summary>posixGroup, groupOfNames or groupOfUniqueNames</summary><p>I went down the rabbithole all the way back to the <a href=https://www.mail-archive.com/ldap@listserver.itd.umich.edu/msg00322.html>2006 mailing list</a> in order to work out what the accepted wisdom is for creating user groups and then ensuring referential integrity with a backref on the user object.</p> <p>As per the <a href>official docs</a> it turns out there's a <code>memberOf</code> attribute that can be maintained on an object to show what groups they are members of. Sounds simple?</p> <blockquote> <p>In some scenarios, it may be desirable for a client to be able to determine which groups an entry is a member of, without performing an additional search. Examples of this are applications using the DIT for access control based on group authorization.</p> <p>The memberof overlay updates an attribute (by default memberOf) whenever changes occur to the membership attribute (by default member) of entries of the objectclass (by default groupOfNames) configured to trigger updates.</p> <p>Thus, it provides maintenance of the list of groups an entry is a member of, when usual maintenance of groups is done by modifying the members on the group entry.</p> </blockquote> <p>It's actually, genuinely, rocket science to get anything like this properly working (or even find some docs that explain it). In order to enable this functionality I found you need to modify the OpenLDAP installation to specifically ask for memberships to be maintained.</p> <div class=highlight><pre><span></span># file: ~/auth/memberOf.ldif
dn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config
objectClass: olcOverlayConfig
objectClass: olcMemberOf
olcOverlay: memberof
olcMemberOfRefint: TRUE
</pre></div> <p>You can apply this manually with <code>ldapadd -Y EXTERNAL -H ldapi:/// -f memberOf.ldif</code> or, as explained in the docker image notes, we can <a href=https://github.com/osixia/docker-openldap#seed-ldap-database-with-ldif>Seed the ldap database with a ldif</a>.</p> <p>We need to add this file into the <code>/container/service/slapd/assets/config/bootstrap/ldif/custom</code> and then add <code>--copy-service</code> to the startup args of the container. In the world of Kubernetes this means mounting via a ConfigMap.</p> <div class=highlight><pre><span></span><span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>memberOf.ldif</span><span class=p>:</span> <span class="p p-Indicator">|</span>
    <span class=no>dn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config</span>
    <span class=no>objectClass: olcOverlayConfig</span>
    <span class=no>objectClass: olcMemberOf</span>
    <span class=no>olcOverlay: memberof</span>
    <span class=no>olcMemberOfRefint: TRUE</span>
</pre></div> <p><strong>Note:</strong> I’m using the name of the file as the key.</p> <p>We can then add this into the <code>volumes</code> and <code>volumeMounts</code> of the container.</p> <details class=example><summary>container</summary><div class=highlight><pre><span></span><span class=nn>...</span>
<span class=nt>containers</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">osixia/openldap</span>
<span class=hll>    <span class=nt>args</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;--copy-service&quot;</span><span class="p p-Indicator">]</span>
</span>    <span class=nt>envFrom</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
    <span class=nt>ports</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">389</span>
      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldaps</span>
    <span class=nt>volumeMounts</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data</span>
      <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/ldap</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
      <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/ldap/slapd.d</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs</span>
      <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/container/service/slapd/assets/certs</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
<span class=hll>      <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/container/service/slapd/assets/config/bootstrap/ldif/custom/memberOf.ldif</span>
</span><span class=hll>      <span class=nt>subPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberOf.ldif</span>
</span><span class=hll>    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">container-run</span>
</span>      <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/container/run</span>
  <span class=nt>volumes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data</span>
    <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
      <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data-pv-claim</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
    <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
      <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config-pv-claim</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs</span>
    <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
      <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs-pv-claim</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
<span class=hll>    <span class=nt>configMap</span><span class=p>:</span>
</span><span class=hll>      <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
</span><span class=hll>  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">container-run</span>
</span>    <span class=nt>emptyDir</span><span class=p>:</span> <span class="p p-Indicator">{}</span>
<span class=nn>...</span>
</pre></div> </details> <p><strong>Note:</strong> the volume references the ConfigMap (memberof-config), the volume mount specifies the mountPath as the file you want to replace (/container/service/slapd/assets/config/bootstrap/ldif/custom/memberOf.ldif) and the subPath property is used to reference the file by key from the ConfigMap <code>data</code> (memberOf.ldif).</p> </details> <p>The final manifest we end up with is below.</p> <details class=example><summary>OpenLDAP manifest</summary><div class=highlight><pre><span></span><span class=c1># file: ~/auth/ldap.yaml</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>memberOf.ldif</span><span class=p>:</span> <span class="p p-Indicator">|</span>
    <span class=no>dn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config</span>
    <span class=no>objectClass: olcOverlayConfig</span>
    <span class=no>objectClass: olcMemberOf</span>
    <span class=no>olcOverlay: memberof</span>
    <span class=no>olcMemberOfRefint: TRUE</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>LDAP_ORGANISATION</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">James Veitch</span>
  <span class=nt>LDAP_DOMAIN</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jamesveitch.dev</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data-pv-claim</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>accessModes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class=nt>resources</span><span class=p>:</span>
    <span class=nt>requests</span><span class=p>:</span>
      <span class=nt>storage</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">20Gi</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config-pv-claim</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>accessModes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class=nt>resources</span><span class=p>:</span>
    <span class=nt>requests</span><span class=p>:</span>
      <span class=nt>storage</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs-pv-claim</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>accessModes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class=nt>resources</span><span class=p>:</span>
    <span class=nt>requests</span><span class=p>:</span>
      <span class=nt>storage</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
  <span class=nt>ports</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
      <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">389</span>
      <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">389</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldaps-tcp</span>
      <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
      <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldaps</span>
      <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">UDP</span>
      <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
      <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-deployment</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>replicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>matchLabels</span><span class=p>:</span>
      <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
      <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
  <span class=nt>strategy</span><span class=p>:</span>
    <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Recreate</span>
  <span class=nt>template</span><span class=p>:</span>
    <span class=nt>metadata</span><span class=p>:</span>
      <span class=nt>labels</span><span class=p>:</span>
        <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
        <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">backend</span>
    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">osixia/openldap</span>
        <span class=nt>args</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&quot;--copy-service&quot;</span><span class="p p-Indicator">]</span>
        <span class=nt>env</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LDAP_ADMIN_PASSWORD</span>
            <span class=nt>valueFrom</span><span class=p>:</span>
              <span class=nt>secretKeyRef</span><span class=p>:</span>
                <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-user-creds</span>
                <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
          <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LDAP_CONFIG_PASSWORD</span>
            <span class=nt>valueFrom</span><span class=p>:</span>
              <span class=nt>secretKeyRef</span><span class=p>:</span>
                <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-user-creds</span>
                <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LDAP_CONFIG_PASSWORD</span>
        <span class=nt>envFrom</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
        <span class=nt>ports</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">389</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldaps</span>
        <span class=nt>volumeMounts</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/ldap</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/ldap/slapd.d</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/container/service/slapd/assets/certs</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/container/service/slapd/assets/config/bootstrap/ldif/custom/memberOf.ldif</span>
          <span class=nt>subPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberOf.ldif</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">container-run</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/container/run</span>
      <span class=nt>volumes</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data</span>
        <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
          <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-data-pv-claim</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config</span>
        <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
          <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-config-pv-claim</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs</span>
        <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
          <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap-certs-pv-claim</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
        <span class=nt>configMap</span><span class=p>:</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">memberof-config</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">container-run</span>
        <span class=nt>emptyDir</span><span class=p>:</span> <span class="p p-Indicator">{}</span>
</pre></div> </details> <p>Apply this manifest with a <code>kubectl apply -f ~/auth/ldap.yaml</code> and then wait for the services and pods to spin up.</p> <div class=highlight><pre><span></span>$ kubectl apply -f ldap.yaml 

configmap/memberof-config created
configmap/ldap-config created
persistentvolumeclaim/ldap-data-pv-claim created
persistentvolumeclaim/ldap-config-pv-claim created
persistentvolumeclaim/ldap-certs-pv-claim created
service/ldap created
deployment.apps/ldap-deployment created
</pre></div> <h3 id=admin>Admin</h3> <p>If you haven't used a pre-canned LDIF file to seed the initial database we can use a friendly admin tool to quickly add some content into the LDAP backend.</p> <details class=example><summary>LDAP Admin manifest</summary><div class=highlight><pre><span></span><span class=c1># file: ~/auth/ldap-admin.yaml</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldapadmin-config</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>PHPLDAPADMIN_LDAP_HOSTS</span><span class=p>:</span> <span class=s>&quot;ldap.auth&quot;</span>
  <span class=nt>PHPLDAPADMIN_HTTPS</span><span class=p>:</span> <span class=s>&quot;false&quot;</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldapadmin</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
  <span class=nt>ports</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
      <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
      <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldapadmin-deployment</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>replicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>matchLabels</span><span class=p>:</span>
      <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
      <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
  <span class=nt>strategy</span><span class=p>:</span>
    <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Recreate</span>
  <span class=nt>template</span><span class=p>:</span>
    <span class=nt>metadata</span><span class=p>:</span>
      <span class=nt>labels</span><span class=p>:</span>
        <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldap</span>
        <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldapadmin</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">osixia/phpldapadmin</span>
        <span class=nt>envFrom</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ldapadmin-config</span>
        <span class=nt>ports</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
</pre></div> </details> <p>This creates an internal (to the LAN) <code>Service</code> using a <code>LoadBalancer</code> so it appears on the network via MetalLB. To get the <code>External-IP</code> query the services in the namespace.</p> <div class=highlight><pre><span></span>$ kubectl get svc -n auth

NAME          TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span class=o>(</span>S<span class=o>)</span>                   AGE
ldap          ClusterIP      <span class=m>10</span>.96.236.102   &lt;none&gt;          <span class=m>389</span>/TCP,636/TCP,636/UDP   14h
<span class=hll>ldapadmin     LoadBalancer   <span class=m>10</span>.96.165.63    <span class=m>192</span>.168.0.201   <span class=m>80</span>:30158/TCP              14h
</span></pre></div> <p>To login to the admin panel you'll need to use the username of <code>cn=admin,dc=jamesveitch,dc=dev</code> and then the password.</p> <p>One the left you should see something similar to the below. Click to <code>Create new entry here</code> so we can add the necessary Organisational Units we'll require later on.</p> <p><img alt="Create new entry" src="../img/Screenshot 2019-12-21 at 13.55.29.png"></p> <p>In the screen that appears choose <code>Generic: Organisational Unit</code> and then call it <code>People</code>. Click through the screens and commit to the database.</p> <details class=tip><summary>Generic: Organisational Unit</summary><p><img alt=OU src="../img/Screenshot 2019-12-21 at 13.58.04.png"></p> </details> <p>If you click on this new <code>ou=People</code> icon and then <code>Add new attribute</code> you'll see down the bottom we can select <code>description</code> from a drop-down box. Type in something descriptive.</p> <blockquote> <p>LDAP tree where users are</p> </blockquote> <details class=tip><summary>Add description</summary><p><img alt=Select src="../img/Screenshot 2019-12-21 at 14.15.10.png"></p> </details> <h4 id=additional-entries>Additional entries</h4> <p>After adding the above, we need to create the following structure, in the following order (LDAP is massively fiddly...). Alternatively you can just import the example <a href=https://github.com/darth-veitcher/homelab/tree/master/manifests/idam/ldap/01.data.ldif>data.ldif</a> via the "Import" functionality.</p> <ul> <li><strong>Organisational Units</strong>: Create these in the same way as above (<code>Generic: Organisational Unit</code> and then add a description attribute).<ul> <li><code>People</code>: LDAP tree where users are</li> <li><code>Groups</code>: LDAP tree for Groups that users belong to<ul> <li><code>RealmRoles</code>: Keycloak roles that users have</li> <li><code>KubernetesRoles</code>: Kubernetes roles that users have</li> </ul> </li> </ul> </li> <li><strong>Users</strong>: These sit inside the <code>People</code> OU tree and should be created as a <code>Default</code> &rarr; <code>inetOrgPerson</code> type. <u>See below section on <code>User Attributes</code> before proceeding.</u></li> <li><strong>Groups</strong>: These sit inside the <code>Groups</code> OU tree and should be created as a <code>groupOfNames</code>. <u>These can only be created after you have a user to assign to them.</u> Select <code>cn</code> as the <code>RDN</code> option from the drop-down when prompted.<ul> <li><code>ldap-user</code>: Standard group for all ldap users. Sits inside <code>RealmRoles</code> OU.</li> <li><code>ldap-admin</code>: Holds general administrators for the domain. Sits inside <code>RealmRoles</code> OU.</li> <li><code>realm-admin</code>: Admin for Keycloak and LDAP. Sits inside <code>RealmRoles</code> OU.</li> <li><code>cluster-admin</code>: Admin for the Kubernetes Cluster. Sits inside <code>KubernetesRoles</code> OU.</li> </ul> </li> </ul> <details class=tip open=open><summary>User Attributes</summary><p>You're presented with a bit of an impenetrable screen when you select <code>Default</code> &rarr; <code>inetOrgPerson</code> type. It's representative of the "standard" agreed LDAP schema for this type and is split into <code>Required</code> and <code>Optional</code> Attributes. I suggest the following are filled in.</p> <table> <thead> <tr> <th>Key</th> <th>Value</th> <th>Notes</th> </tr> </thead> <tbody> <tr> <td>RDN</td> <td>User Name (uid)</td> <td>Name of the attribute used as the "top" of a typical user DN (Distinguished Name).</td> </tr> <tr> <td>cn</td> <td>James</td> <td>First Name</td> </tr> <tr> <td>sn</td> <td>Veitch</td> <td>Last Name</td> </tr> <tr> <td>Password</td> <td>supersecurepassword</td> <td>Select the <code>sha512crypt</code> option</td> </tr> <tr> <td>User Name</td> <td>jamesveitch</td> <td>Actually an alias for <code>uid</code></td> </tr> </tbody> </table> </details> <h3 id=export-configuration-as-ldif>Export configuration as LDIF</h3> <p>The <em>really</em> helpful thing about this admin interface is that it contains an <code>Export</code> functionality we can use to save down a copy of our databse for subsequent seeding / backup.</p> <p>Make sure you set the following:</p> <ul> <li><code>Base DN</code>: use the root <code>dc=jamesveitch,dc=dev</code> or just leave blank</li> <li><code>Search Scope</code>: Select the entire subtree</li> <li><code>Attributes</code>: Keep the wildcard <code>*</code></li> <li><code>Save as file</code>: Select this</li> <li><code>Export format</code>: LDIF</li> <li><code>Line ends</code>: UNIX</li> </ul> <details class=tip><summary>Export</summary><p><img alt=Export src="../img/Screenshot 2019-12-21 at 14.27.33.png"> <img alt="Export Settings" src="../img/Screenshot 2019-12-21 at 14.27.46.png"></p> </details> <h3 id=seed-the-database-with-the-exported-ldif-or-your-own>Seed the database with the exported LDIF (or your own)</h3> <p>(#TODO: Implement as part of manifest). See <a href=https://github.com/osixia/docker-openldap#seed-ldap-database-with-ldif>seed-ldap-database-with-ldif</a> from the docs.</p> <p>For now you can just "import" the LDIF quickly in the admin interface.</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../00.idam/ title="IDAM Overview" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> IDAM Overview </span> </div> </a> <a href=../02.keycloak/ title=Keycloak class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Keycloak </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight id=copy> <!-- &copy Darth Veitcher 2019-&date --> </div> <script type=text/javascript>
            let theDate=new Date();
            copy.innerHTML = "&copy Darth Veitcher "+theDate.getFullYear();
        </script> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/darth-veitcher class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.808e90bb.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>