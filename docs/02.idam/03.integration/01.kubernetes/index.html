<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An overkill homelab setup"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Kubernetes (API) - Homelab</title><link rel=stylesheet href=../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CHackman&display=fallback"><style>body,input{font-family:"","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hackman","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=teal> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#configure-keycloak tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=../../.. title=Homelab class="md-header-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Homelab </span> <span class=md-header-nav__topic> Kubernetes (API) </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=../../.. title=Homelab class="md-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> Homelab </label> <div class=md-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=Introduction class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Infrastructure </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/01.hosts/00.configuring.physical.nodes/ title="Host Configuration" class=md-nav__link> Host Configuration </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Hosts </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Hosts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-1 type=checkbox id=nav-2-2-1> <label class=md-nav__link for=nav-2-2-1> On-prem </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-1> On-prem </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/01.hosts/01.banks/ title="Compute (Banks)" class=md-nav__link> Compute (Banks) </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/01.hosts/02.clarke/ title="Storage (Clarke)" class=md-nav__link> Storage (Clarke) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-2 type=checkbox id=nav-2-2-2> <label class=md-nav__link for=nav-2-2-2> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-2> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/01.hosts/03.donaldson/ title="Compute (Donaldson)" class=md-nav__link> Compute (Donaldson) </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/01.hosts/04.hamilton/ title="Ingress (Hamilton)" class=md-nav__link> Ingress (Hamilton) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Kubernetes Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Kubernetes Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/02.kubernetes/00.configuring.kubernetes/ title="Install Kubernetes" class=md-nav__link> Install Kubernetes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2> <label class=md-nav__link for=nav-2-3-2> Initial Networking </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-2> Initial Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/02.kubernetes/01.cni/ title=CNI class=md-nav__link> CNI </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/02.kubernetes/02.metallb/ title="Load Balancer" class=md-nav__link> Load Balancer </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/02.kubernetes/03.ingress/ title=Ingress class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/03.certificates/00.cert.manager/ title="TLS Certificates Management" class=md-nav__link> TLS Certificates Management </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> CEPH Storage with Rook </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> CEPH Storage with Rook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/04.storage/00.setup.ceph.storage.with.rook/ title="Install the Cluster" class=md-nav__link> Install the Cluster </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/04.storage/01.dashboard/ title="Setup Dashboard" class=md-nav__link> Setup Dashboard </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5-3 type=checkbox id=nav-2-5-3> <label class=md-nav__link for=nav-2-5-3> Storage Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-5-3> Storage Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/04.storage/02.storage/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/04.storage/0200.block/ title=Block class=md-nav__link> Block </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/04.storage/0201.filesystem/ title=Filesystem class=md-nav__link> Filesystem </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/04.storage/0202.object/ title=Object class=md-nav__link> Object </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-6 type=checkbox id=nav-2-6> <label class=md-nav__link for=nav-2-6> Monitoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-6> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../01.infrastructure/05.monitoring/00.monitoring.with.prometheus.and.grafana/ title="Prometheus and Grafana" class=md-nav__link> Prometheus and Grafana </a> </li> <li class=md-nav__item> <a href=../../../01.infrastructure/05.monitoring/01.kubernetes.dashboard/ title="Kubernetes Dashboard" class=md-nav__link> Kubernetes Dashboard </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> Identity and Access Management (IDAM) </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Identity and Access Management (IDAM) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../00.idam/ title="IDAM Overview" class=md-nav__link> IDAM Overview </a> </li> <li class=md-nav__item> <a href=../../01.openldap/ title=OpenLDAP class=md-nav__link> OpenLDAP </a> </li> <li class=md-nav__item> <a href=../../02.keycloak/ title=Keycloak class=md-nav__link> Keycloak </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4 checked> <label class=md-nav__link for=nav-3-4> Integration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-3-4> Integration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../00.integration/ title=Overview class=md-nav__link> Overview </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Kubernetes (API) </label> <a href=./ title="Kubernetes (API)" class="md-nav__link md-nav__link--active"> Kubernetes (API) </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#configure-keycloak class=md-nav__link> Configure Keycloak </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#telling-applications-about-our-users-groupsroles class=md-nav__link> Telling applications about our users groups/roles </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-kubectl-with-kubelogin class=md-nav__link> Configure Kubectl with kubelogin </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-latest-version class=md-nav__link> Install latest version </a> </li> <li class=md-nav__item> <a href=#1-set-up-the-oidc-provider class=md-nav__link> 1. Set up the OIDC provider </a> </li> <li class=md-nav__item> <a href=#2-verify-authentication class=md-nav__link> 2. Verify authentication </a> </li> <li class=md-nav__item> <a href=#3-bind-a-role class=md-nav__link> 3. Bind a role </a> </li> <li class=md-nav__item> <a href=#4-set-up-the-kubernetes-api-server class=md-nav__link> 4. Set up the Kubernetes API server </a> </li> <li class=md-nav__item> <a href=#5-set-up-the-kubeconfig class=md-nav__link> 5. Set up the kubeconfig </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#external-kubeconfig class=md-nav__link> External ~/.kube/config </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../02.kubernetes.dashboard/ title="Kubernetes (Dashboard)" class=md-nav__link> Kubernetes (Dashboard) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Snippets </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Snippets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../99.snippets/storage.disks/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../../99.snippets/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../99.snippets/ceph/ title=Ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#configure-keycloak class=md-nav__link> Configure Keycloak </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#telling-applications-about-our-users-groupsroles class=md-nav__link> Telling applications about our users groups/roles </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-kubectl-with-kubelogin class=md-nav__link> Configure Kubectl with kubelogin </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#install-latest-version class=md-nav__link> Install latest version </a> </li> <li class=md-nav__item> <a href=#1-set-up-the-oidc-provider class=md-nav__link> 1. Set up the OIDC provider </a> </li> <li class=md-nav__item> <a href=#2-verify-authentication class=md-nav__link> 2. Verify authentication </a> </li> <li class=md-nav__item> <a href=#3-bind-a-role class=md-nav__link> 3. Bind a role </a> </li> <li class=md-nav__item> <a href=#4-set-up-the-kubernetes-api-server class=md-nav__link> 4. Set up the Kubernetes API server </a> </li> <li class=md-nav__item> <a href=#5-set-up-the-kubeconfig class=md-nav__link> 5. Set up the kubeconfig </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#external-kubeconfig class=md-nav__link> External ~/.kube/config </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> References </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/darth-veitcher/homelab/edit/master/docs/02.idam/03.integration/01.kubernetes.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>Kubernetes (API)</h1> <p>There's an excellent article on <a href=https://medium.com/@mrbobbytables/kubernetes-day-2-operations-authn-authz-with-oidc-and-a-little-help-from-keycloak-de4ea1bdbbe>Medium</a> which partially covers what we're about to do and helped to solidify some of my thoughts. Highly worth a read for some background. In addition there's some official docs on <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens>OpenID Connect Tokens</a>. At the bottom of this page I've included links to all of the <a href=#references>references</a> I ended up needing to make this work.</p> <p>We're going to now integrate our Kubernetes cluster's <code>Authentication</code> (identify someone) and <code>Authorisation</code> (what they should be able to do) with our Keycloak+OpenLDAP implementation.</p> <p>Initially I'm going to prove that we should be able to login as <code>jamesveitch</code> (my <code>uid</code>).</p> <details class=tip><summary>LDIF Export: James Veitch</summary><p>Remember we exported the LDIF? If you review the file you'll see the following. <div class=highlight><pre><span></span># Entry 11: cn=James Veitch,ou=People,dc=jamesveitch,dc=dev
dn: cn=James Veitch,ou=People,dc=jamesveitch,dc=dev
cn: James Veitch
gidnumber: 500
givenname: James
homedirectory: /home/users/jamesveitch
loginshell: /bin/bash
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: Veitch
<span class=hll>uid: jamesveitch
</span>uidnumber: 1000
userpassword: {CRYPT}$6$uby4/8dS$23r8h349f$ggnQE7Z7GUIW3IXe.1z4pUZ4HDQlukEwB6N4z6/p
swn6r2Pg40wF6w5wopOP1f46f4MOI7BJ0
</pre></div></p> </details> <h3 id=configure-keycloak>Configure Keycloak</h3> <p>We need to setup a new <code>Client</code> inside Keycloak for Kubernetes to allow the Kubernetes API Server to authenticate users and read attributes (like whether or not they're members of the <code>cluster-admin</code> group).</p> <p>Login to Keycloak and, in the <code>Development</code> realm, create a new client with <code>Clients</code> &rarr; <code>Create</code>.</p> <details class=example><summary>Create Client</summary><p><img alt="Create Client" src="../img/Screenshot 2019-12-28 at 15.13.48.png"></p> </details> <ul> <li><code>Client ID</code>: kubernetes</li> <li><code>Protocol</code>: openid-connect</li> <li><code>Root URL</code>: (leave this blank)</li> </ul> <p>You're now presented with a fairly lengthy configuration screen. Use the following options as overrides to what should be provided as existing defaults.</p> <ul> <li><code>Access Type</code>: confidential</li> <li><code>Valid Redirect URIs</code>: <ul> <li><a href=http://localhost:8000>http://localhost:8000</a></li> <li><a href=http://localhost:18000>http://localhost:18000</a></li> </ul> </li> </ul> <p>Once saved we now have a new client.</p> <details class=tip open=open><summary>Tip</summary><p>Navigating to the <code>Credentials</code> tab will show the necessary <code>secret</code> that needs to be given to Kubernetes.</p> </details> <h4 id=telling-applications-about-our-users-groupsroles>Telling applications about our users groups/roles</h4> <p>There's a few ways to achieve the outcome we're looking for &rarr; obtain a list of <code>Groups</code> for a selected <code>User</code> from OpenLDAP and then inform an application in our token response of these when authenticating this user. The same way we performed some <code>mapping</code> from OpenLDAP into the Keycloak schema previously we'll now need to perform a similar task from Keycloak to our respective applications.</p> <p>I'll cover both methods of passing data back in the token:</p> <ul> <li>Realm-wide change to a default <code>Client Scope</code></li> <li>Individual client <code>Mapper</code></li> </ul> <details><summary>Realm-wide <code>Scope</code></summary><p>By default Keycloak creates a set of default <code>scopes</code> for all clients which sit in the <code>Client Scopes</code> menu. If you click on the tab with the same name in the kubernetes client we've created you'll see that theres some sub-tabs for <code>Setup</code> and <code>Evaluate</code>.</p> <details class=example open=open><summary>Setup</summary><p>By default our client has access to the <code>roles</code> scope.</p> <p><img alt=Setup src="../img/Screenshot 2019-12-28 at 22.50.36.png"></p> </details> <details class=example><summary>Evaluate</summary><p>If you select your user and click <code>Evaluate</code> it will show you the token you'll be returning to Kubernetes.</p> <p><img alt=Evaluate src="../img/Screenshot 2019-12-28 at 22.49.52.png"></p> </details> <p>We can hook into this mechanic if we want so that, by default, the <code>roles</code> scope returns a list of <code>Groups</code> our user is part of.</p> <details class=example><summary>User Groups</summary><p>You can check in Keycloak against your user - this will show what we've already mapped through from OpenLDAP.</p> <p><img alt="User Groups" src="../img/Screenshot 2019-12-28 at 22.54.46.png"></p> </details> <p>First off we can change the <code>roles</code> scope globally to include some additional information about <code>groups</code>. This gets assigned by default to all clients.</p> <p>Navigate to <code>Client Scopes</code> &rarr; <code>roles</code> (edit) &rarr; <code>Mappers</code> (tab) and add a new one.</p> <ul> <li>Name: <code>groups</code></li> <li>Mapper Type: <code>Group Membership</code></li> <li>Token Claim Name: <code>groups</code></li> </ul> <details class=example><summary>Add Mapper to Default Scope</summary><p><img alt=Mappers src="../img/Screenshot 2019-12-28 at 22.59.47.png"> <img alt=Details src="../img/Screenshot 2019-12-28 at 23.06.45.png"></p> </details> <p>If you <code>evaluate</code> the client for your user you'll now see the following in the token.</p> <div class=highlight><pre><span></span><span class=err>...</span>
<span class=s2>&quot;groups&quot;</span><span class=err>:</span> <span class=p>[</span>
  <span class=s2>&quot;/ldap-user&quot;</span><span class=p>,</span>
  <span class=s2>&quot;/realm-admin&quot;</span><span class=p>,</span>
  <span class=s2>&quot;/ldap-admin&quot;</span><span class=p>,</span>
  <span class=s2>&quot;/cluster-admin&quot;</span>
<span class=p>]</span><span class=err>,</span>
<span class=err>...</span>
</pre></div> </details> <details><summary>Client <code>Mapper</code></summary><p>You can associate groups for an individual client by adding the following mapper:</p> <ul> <li><code>Name</code>: groups</li> <li><code>Mapper Type</code>: Group Membership</li> <li><code>Client ID</code>: kubernetes</li> <li><code>Token Claim Name</code>: groups</li> <li><code>Add to ID token</code>: on</li> </ul> </details> <h3 id=configure-kubectl-with-kubelogin>Configure Kubectl with <code>kubelogin</code></h3> <p><a href=https://github.com/int128/kubelogin>Kubelogin</a> is a <code>kubectl</code> plugin for Kubernetes OpenID Connect authentication designed to allow you to obtain a token from keycloak (or any OIDC provider) and then pass this to kubectl to use to authenticate as your user.</p> <p><img alt="Credential Plugin" src="https://github.com/int128/kubelogin/raw/master/docs/credential-plugin-diagram.svg?sanitize=true"></p> <h4 id=install-latest-version>Install latest version</h4> <div class=highlight><pre><span></span><span class=nb>export</span> <span class=nv>KUBELOGIN_VERSION</span><span class=o>=</span>v1.15.2
curl -LO https://github.com/int128/kubelogin/releases/download/<span class=si>${</span><span class=nv>KUBELOGIN_VERSION</span><span class=si>}</span>/kubelogin_linux_amd64.zip
7z x kubelogin_linux_amd64.zip
chmod +x kubelogin
sudo mv kubelogin /usr/local/bin/kubectl-oidc_login
rm kubelogin_linux_amd64.zip LICENSE
</pre></div> <h4 id=1-set-up-the-oidc-provider>1. Set up the OIDC provider</h4> <p>We should now be able to run an initial setup command, using the credentials we created in Keycloak for the client.</p> <details class=warning open=open><summary>Local Port Forwarding</summary><p>If you're working on a remote headless server (like me) then, in order for the below to work, you'll need to forward the port <code>8000</code> from your remote host to localhost so that the oidc webpage that grabs your token can load.</p> <div class=highlight><pre><span></span>ssh -L <span class=m>8000</span>:localhost:8000 adminlocal@banks.local
</pre></div> </details> <div class=superfences-tabs> <input name=__tabs_1 type=radio id=__tab_1_0 checked=checked> <label for=__tab_1_0>1. Set up the OIDC provider</label> <div class=superfences-content><div class=highlight><pre><span></span>kubectl oidc-login setup <span class=se>\</span>
    --oidc-issuer-url<span class=o>=</span>https://auth.jamesveitch.dev/auth/realms/development <span class=se>\</span>
    --oidc-client-id<span class=o>=</span>kubernetes <span class=se>\</span>
    --oidc-client-secret<span class=o>=</span>YOUR_CLIENT_SECRET
</pre></div></div> </div> <p>On successfully validating access via localhost:8000 the following will be displayed. Have a quick look but don't worry, we'll step through each step individually.</p> <details class=info><summary>Command Output</summary><div class=superfences-tabs> <input name=__tabs_2 type=radio id=__tab_2_0 checked=checked> <label for=__tab_2_0>2. Verify authentication</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=c1>## 2. Verify authentication</span>
Open http://localhost:8000 <span class=k>for</span> authentication

You got the following claims in the token:
    <span class=nv>acr</span><span class=o>=</span><span class=m>1</span>
    <span class=nv>nbf</span><span class=o>=</span><span class=m>0</span>
    <span class=nv>iss</span><span class=o>=</span>https://auth.jamesveitch.dev/auth/realms/development
    <span class=nv>nonce</span><span class=o>=</span>grKgiUYt6w5R6shPmv_kIoKa5eDf6n310VDG5aaFg1s
    <span class=nv>session_state</span><span class=o>=</span>4de7b14d-df9c-4edd-b165-54731bb74d76
    <span class=nv>name</span><span class=o>=</span>James Veitch
    <span class=nv>preferred_username</span><span class=o>=</span>jamesveitch
    <span class=nv>groups</span><span class=o>=[</span>/ldap-user /realm-admin /ldap-admin /cluster-admin<span class=o>]</span>
    <span class=nv>family_name</span><span class=o>=</span>Veitch
    <span class=nv>exp</span><span class=o>=</span><span class=m>1577571593</span>
    <span class=nv>email_verified</span><span class=o>=</span><span class=nb>false</span>
    <span class=nv>aud</span><span class=o>=</span>kubernetes
    <span class=nv>sub</span><span class=o>=</span>f0db1df3-5a2f-4095-b556-72912f8315cf
    <span class=nv>azp</span><span class=o>=</span>kubernetes
    <span class=nv>given_name</span><span class=o>=</span>James
    <span class=nv>iat</span><span class=o>=</span><span class=m>1577571293</span>
    <span class=nv>typ</span><span class=o>=</span>ID
    <span class=nv>auth_time</span><span class=o>=</span><span class=m>1577571293</span>
    <span class=nv>jti</span><span class=o>=</span>0dfc35b1-99e3-4f4b-8e4d-89424b1b3e51
</pre></div></div> <input name=__tabs_2 type=radio id=__tab_2_1> <label for=__tab_2_1>3. Bind a role</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=c1>## 3. Bind a role</span>

Run the following command:

  kubectl apply -f - <span class=s>&lt;&lt;-EOF</span>
<span class=s>  kind: ClusterRoleBinding</span>
<span class=s>  apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>  metadata:</span>
<span class=s>    name: oidc-cluster-admin</span>
<span class=s>  roleRef:</span>
<span class=s>    apiGroup: rbac.authorization.k8s.io</span>
<span class=s>    kind: ClusterRole</span>
<span class=s>    name: cluster-admin</span>
<span class=s>  subjects:</span>
<span class=s>  - kind: User</span>
<span class=s>    name: https://auth.jamesveitch.dev/auth/realms/development#</span>
<span class=s>  EOF</span>
</pre></div></div> <input name=__tabs_2 type=radio id=__tab_2_2> <label for=__tab_2_2>4. Set up the Kubernetes API server</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=c1>## 4. Set up the Kubernetes API server</span>

Add the following options to the kube-apiserver:

  --oidc-issuer-url<span class=o>=</span>https://auth.jamesveitch.dev/auth/realms/development
  --oidc-client-id<span class=o>=</span>kubernetes
</pre></div></div> <input name=__tabs_2 type=radio id=__tab_2_3> <label for=__tab_2_3>5. Set up the kubeconfig</label> <div class=superfences-content><div class=highlight><pre><span></span><span class=c1>## 5. Set up the kubeconfig</span>

<span class=nt>Add the following user to the kubeconfig</span><span class=p>:</span>

  <span class=nt>users</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">google</span>
    <span class=nt>user</span><span class=p>:</span>
      <span class=nt>exec</span><span class=p>:</span>
        <span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">client.authentication.k8s.io/v1beta1</span>
        <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubectl</span>
        <span class=nt>args</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">oidc-login</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">get-token</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-issuer-url=https://auth.jamesveitch.dev/auth/realms/development</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-id=kubernetes</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-secret=5ffe6efd-bc31-4009-bec4-0ef2f0b15505</span>
</pre></div></div> </div> </details> <h4 id=2-verify-authentication>2. Verify authentication</h4> <p>If we look at the commands output in this section you can see that it shows the details of the token received from Keycloak. A couple of important bits to note.</p> <ul> <li><strong>preferred_username</strong>: This is what we will be using to log into kubernetes resources (and matches our username for keycloak)</li> <li><strong>groups</strong>: An array of groups our user is a member of. Importantly we've got <code>/cluster-admin</code> in here... we'll have to access this with <code>oidc:/cluster-admin</code> in our RBAC manifests later with the prefix we'll set in the kube-apiserver.</li> </ul> <h4 id=3-bind-a-role>3. Bind a role</h4> <p>If you were the impatient type and tried to immediately connect with kubectl you would find that, despite finding your user, you still cen't actually fdo anything. This is because, by default, the RBAC in kubernetes is set to deny all.</p> <div class=highlight><pre><span></span>adminlocal@banks:~$ kubectl get pods

Open http://localhost:8000 <span class=k>for</span> authentication
Error from server <span class=o>(</span>Forbidden<span class=o>)</span>: pods is forbidden: User <span class=s2>&quot;https://auth.jamesveitch.dev/auth/realms/development#jamesveitch&quot;</span> cannot list resource <span class=s2>&quot;pods&quot;</span> in API group <span class=s2>&quot;&quot;</span> in the namespace <span class=s2>&quot;default&quot;</span>
</pre></div> <p>We need to setup a mapping now between our <code>/cluster-admin</code> group from OpenLDAP and our default <code>cluster-admin</code> role in Kubernetes. We could also assign this directly to our <code>User</code> but that feels dirty and inflexible. Left here for reference but commented out.</p> <div class=highlight><pre><span></span><span class=c1># file: ~/auth/cluster-admin.yaml</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">oidc-cluster-admins</span>
<span class=nt>roleRef</span><span class=p>:</span>
  <span class=nt>apiGroup</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class=c1># - apiGroup: rbac.authorization.k8s.io</span>
<span class=c1>#   kind: User</span>
<span class=c1>#   name: oidc/jamesveitch</span>
<span class="p p-Indicator">-</span> <span class=nt>apiGroup</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Group</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">oidc/cluster-admin</span>
</pre></div> <p>Apply with <code>kubectl apply -f ~/auth/cluster-admin.yaml</code>.</p> <h4 id=4-set-up-the-kubernetes-api-server>4. Set up the Kubernetes API server</h4> <p>We'll now <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#configuring-the-api-server>configure the Kubernetes API Server</a> to authenticate against an OIDC provider. In our case that's Keycloak.</p> <p>This is running as it's own pod currently and we initialised it originally with our <code>kubeadm</code> command when <a href=../../../01.infrastructure/02.kubernetes/00.configuring.kubernetes/ >configuring kubernetes</a>.</p> <div class=highlight><pre><span></span>$ kubectl -n kube-system get pods

NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-74c9747c46-qlcqc   <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
calico-node-f5t9f                          <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
coredns-6955765f44-49w5d                   <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
coredns-6955765f44-gvqlw                   <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
etcd-banks.local                           <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
<span class=hll>kube-apiserver-banks.local                 <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
</span>kube-controller-manager-banks.local        <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
kube-proxy-lxsr6                           <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
kube-scheduler-banks.local                 <span class=m>1</span>/1     Running   <span class=m>2</span>          9d
</pre></div> <p>If you look inside this pod with <code>describe</code> you'll see some commands have been passed to the container. We essentially need to edit and add to these so that it knows about our OIDC settings. The configuration file is stored by kubeadm in <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>.</p> <div class=highlight><pre><span></span><span class=c1># file: /etc/kubernetes/manifests/kube-apiserver.yaml</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>containers</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>command</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">kube-apiserver</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--advertise-address=192.168.0.104</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--allow-privileged=true</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--authorization-mode=Node,RBAC</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--client-ca-file=/etc/kubernetes/pki/ca.crt</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--enable-admission-plugins=NodeRestriction</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--enable-bootstrap-token-auth=true</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--etcd-servers=https://127.0.0.1:2379</span>
    <span class="l l-Scalar l-Scalar-Plain">...</span>
<span class=hll>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-issuer-url=https://auth.jamesveitch.dev/auth/realms/development</span>
</span><span class=hll>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-id=kubernetes</span>
</span><span class=hll>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-username-claim=preferred_username</span>
</span><span class=hll>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-username-prefix=oidc/</span>
</span><span class=hll>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-groups-claim=groups</span>
</span><span class=hll>    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-groups-prefix=oidc</span>
</span></pre></div> <p><strong>NB:</strong> You'll notice that the <code>oidc/</code> and <code>oidc</code> are different for the groups and users above... This is deliberate as the groups come through automatically with the <code>/</code> prefixed to them. In addition I was unable to get the apiserver to load with the default <code>:</code> appended - must be an error with unsanitised string inputs to the commandline.</p> <p>Once modified this should actually be detected and automatically reloaded/applied.</p> <details class=tip><summary>Debugging the API Server</summary><p>If something goes wrong above your apiserver will simply fail to load and you'll lose access to the cluster. To debug, run the following command and check the logs.</p> <div class=highlight><pre><span></span>sudo docker logs <span class=k>$(</span>sudo docker ps -a <span class=p>|</span> grep k8s_kube-apiserver<span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</pre></div> <p>Or, even better, undo what you've just done...</p> </details> <h4 id=5-set-up-the-kubeconfig>5. Set up the kubeconfig</h4> <p>Whilst the output from the initial setup command was a little cryptic, it's trying to tell us to create a new user associated with our cluster and then specify how credentials need to be obtained.</p> <p>Edit your <code>~/.kube/config</code> and ensure we do the following:</p> <ul> <li><strong>contexts:</strong> add a <code>user</code> to our <code>context</code> for the correct <code>cluster</code> (in our case <code>kubernetes</code>) called <code>keycloak</code></li> <li><strong>users:</strong> create a user called <code>keycloak</code> with the correct oidc settings.</li> </ul> <details class=example><summary><code>~/.kube/config</code></summary><div class=highlight><pre><span></span><span class=c1># file: ~/.kube/config</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>clusters</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>cluster</span><span class=p>:</span>
    <span class=nt>certificate-authority-data</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWU$</span>
    <span class=nt>server</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://192.168.0.104:6443</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<span class=nt>contexts</span><span class=p>:</span>
<span class=hll><span class="p p-Indicator">-</span> <span class=nt>context</span><span class=p>:</span>
</span><span class=hll>    <span class=nt>cluster</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
</span><span class=hll>    <span class=nt>user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span class=hll>  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-oidc</span>
</span><span class=hll><span class=nt>current-context</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-oidc</span>
</span><span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Config</span>
<span class=nt>preferences</span><span class=p>:</span> <span class="p p-Indicator">{}</span>
<span class=nt>users</span><span class=p>:</span>
<span class=hll><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
</span><span class=hll>  <span class=nt>user</span><span class=p>:</span>
</span><span class=hll>    <span class=nt>exec</span><span class=p>:</span>
</span><span class=hll>      <span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">client.authentication.k8s.io/v1beta1</span>
</span><span class=hll>      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubectl</span>
</span><span class=hll>      <span class=nt>args</span><span class=p>:</span>
</span><span class=hll>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">oidc-login</span>
</span><span class=hll>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">get-token</span>
</span><span class=hll>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-issuer-url=https://auth.jamesveitch.dev/auth/realms/development</span>
</span><span class=hll>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-id=kubernetes</span>
</span><span class=hll>      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-secret=5ffe6efd-bc31-4009-bec4-0ef2f0b15505</span>
</span></pre></div> </details> <h3 id=external-kubeconfig>External <code>~/.kube/config</code></h3> <p>At the moment we've been working exclusively within one of the nodes via ssh. Ideally though we can now copy this config somewhere locally to our actual development machine and leave any hardcoded credentials (like the admin keys) on the server instead.</p> <p>Follow the <a href=https://github.com/int128/kubelogin#setup>setup</a> guide to install <code>kubelogin</code> on the client machine and then configure your <code>~/.kube/config</code> as follows, changing out the necessary sections as appropriate (e.g. the server ip address).</p> <div class=highlight><pre><span></span><span class=c1># file: ~/.kube/config</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>clusters</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>cluster</span><span class=p>:</span>
    <span class=nt>certificate-authority-data</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWU$</span>
    <span class=nt>server</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">https://192.168.0.104:6443</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<span class=nt>contexts</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>context</span><span class=p>:</span>
    <span class=nt>cluster</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
    <span class=nt>user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-oidc</span>
<span class=nt>current-context</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-oidc</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Config</span>
<span class=nt>preferences</span><span class=p>:</span> <span class="p p-Indicator">{}</span>
<span class=nt>users</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
  <span class=nt>user</span><span class=p>:</span>
    <span class=nt>exec</span><span class=p>:</span>
      <span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">client.authentication.k8s.io/v1beta1</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">kubectl</span>
      <span class=nt>args</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">oidc-login</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">get-token</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-issuer-url=https://auth.jamesveitch.dev/auth/realms/development</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-id=kubernetes</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--oidc-client-secret=5ffe6efd-bc31-4009-bec4-0ef2f0b15505</span>
</pre></div> <p>This file can now be provided to anyone* in a secure** fashion. </p> <ul> <li> <p>* They'll need to be able to route to the cluster's IP address (more on that later); and</p> </li> <li> <p>** have a valid login in LDAP for it to be of any use though.</p> </li> </ul> <h3 id=references>References</h3> <p>As detailed in <a href=https://github.com/darth-veitcher/homelab/issues/19>Issue #19</a> the following were helpful resources in my travels to get this working.</p> <ul> <li><a href=https://medium.com/@mrbobbytables/kubernetes-day-2-operations-authn-authz-with-oidc-and-a-little-help-from-keycloak-de4ea1bdbbe>Kubernetes Day 2 Operations: AuthN/AuthZ with OIDC and a Little Help From Keycloak</a></li> <li><a href=https://blog.exceptionerror.io/2018/08/29/openldap-keycloak-and-docker/ >Openldap Keycloak and docker</a></li> <li><a href=https://medium.com/@hbceylan/deep-dive-kubernetes-single-sign-on-sso-with-openid-connection-via-g-suite-a4f01bd4a48f>Deep Dive: Kubernetes Single Sign-On (SSO) with OpenID Connection via G Suite</a></li> <li><a href=https://www.tigera.io/blog/single-sign-on-for-kubernetes-dashboard-experience/ >Single Sign-On for Kubernetes: Dashboard Experience</a></li> <li><a href=https://blog.codecentric.de/en/2019/05/configuring-kubernetes-login-keycloak/ >Configuring Kubernetes login with Keycloak</a></li> <li><a href=https://medium.com/@int128/kubectl-with-openid-connect-43120b451672>kubectl with OpenID Connect</a></li> <li><a href=https://itnext.io/protect-kubernetes-dashboard-with-openid-connect-104b9e75e39c>Protect Kubernetes Dashboard with OpenID Connect</a></li> <li><a href=https://www.tremolosecurity.com/kubernetes-identity-management-part-ii-rbac-and-user-provisioning/ >Kubernetes Identity Management Part II  RBAC and User Provisioning</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../00.integration/ title=Overview class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> Overview </span> </div> </a> <a href=../02.kubernetes.dashboard/ title="Kubernetes (Dashboard)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Kubernetes (Dashboard) </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight id=copy> <!-- &copy Darth Veitcher 2019-&date --> </div> <script type=text/javascript>
            let theDate=new Date();
            copy.innerHTML = "&copy Darth Veitcher "+theDate.getFullYear();
        </script> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/darth-veitcher class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.808e90bb.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>