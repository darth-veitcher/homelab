<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An overkill homelab setup"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>Keycloak - Homelab</title><link rel=stylesheet href=../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abel:300,400,400i,700%7CHackman&display=fallback"><style>body,input{font-family:"Abel","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Hackman","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../assets/fonts/material-icons.css></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=teal> <svg class=md-svg> <defs> <svg xmlns=http://www.w3.org/2000/svg width=416 height=448 viewbox="0 0 416 448" id=__github><path fill=currentColor d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#set-secrets tabindex=1 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=../.. title=Homelab class="md-header-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Homelab </span> <span class=md-header-nav__topic> Keycloak </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> </div> </div> </nav> </header> <div class=md-container> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=../.. title=Homelab class="md-nav__button md-logo"> <i class=md-icon>vpn_lock</i> </a> Homelab </label> <div class=md-nav__source> <a href=https://github.com/darth-veitcher/homelab/ title="Go to repository" class=md-source data-md-source=github> <div class=md-source__icon> <svg viewbox="0 0 24 24" width=24 height=24> <use xlink:href=#__github width=24 height=24></use> </svg> </div> <div class=md-source__repository> darth-veitcher/homelab </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Introduction class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Infrastructure </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Infrastructure </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/00.configuring.physical.nodes/ title="Host Configuration" class=md-nav__link> Host Configuration </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Hosts </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Hosts </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-1 type=checkbox id=nav-2-2-1> <label class=md-nav__link for=nav-2-2-1> On-prem </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-1> On-prem </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/01.banks/ title="Compute (Banks)" class=md-nav__link> Compute (Banks) </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/02.clarke/ title="Storage (Clarke)" class=md-nav__link> Storage (Clarke) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2-2 type=checkbox id=nav-2-2-2> <label class=md-nav__link for=nav-2-2-2> Cloud </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-2-2> Cloud </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/03.donaldson/ title="Compute (Donaldson)" class=md-nav__link> Compute (Donaldson) </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/01.hosts/04.hamilton/ title="Ingress (Hamilton)" class=md-nav__link> Ingress (Hamilton) </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3> <label class=md-nav__link for=nav-2-3> Kubernetes Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> Kubernetes Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/00.configuring.kubernetes/ title="Install Kubernetes" class=md-nav__link> Install Kubernetes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2> <label class=md-nav__link for=nav-2-3-2> Initial Networking </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-2> Initial Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/01.cni/ title=CNI class=md-nav__link> CNI </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/02.metallb/ title="Load Balancer" class=md-nav__link> Load Balancer </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/02.kubernetes/03.ingress/ title=Ingress class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../01.infrastructure/03.certificates/00.cert.manager/ title="TLS Certificates Management" class=md-nav__link> TLS Certificates Management </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5 type=checkbox id=nav-2-5> <label class=md-nav__link for=nav-2-5> CEPH Storage with Rook </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-5> CEPH Storage with Rook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/00.setup.ceph.storage.with.rook/ title="Install the Cluster" class=md-nav__link> Install the Cluster </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/01.dashboard/ title="Setup Dashboard" class=md-nav__link> Setup Dashboard </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-5-3 type=checkbox id=nav-2-5-3> <label class=md-nav__link for=nav-2-5-3> Storage Configuration </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-5-3> Storage Configuration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/02.storage/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/0200.block/ title=Block class=md-nav__link> Block </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/0201.filesystem/ title=Filesystem class=md-nav__link> Filesystem </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/04.storage/0202.object/ title=Object class=md-nav__link> Object </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-6 type=checkbox id=nav-2-6> <label class=md-nav__link for=nav-2-6> Monitoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-6> Monitoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01.infrastructure/05.monitoring/00.monitoring.with.prometheus.and.grafana/ title="Prometheus and Grafana" class=md-nav__link> Prometheus and Grafana </a> </li> <li class=md-nav__item> <a href=../../01.infrastructure/05.monitoring/01.kubernetes.dashboard/ title="Kubernetes Dashboard" class=md-nav__link> Kubernetes Dashboard </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> Identity and Access Management (IDAM) </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Identity and Access Management (IDAM) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../00.idam/ title="IDAM Overview" class=md-nav__link> IDAM Overview </a> </li> <li class=md-nav__item> <a href=../01.openldap/ title=OpenLDAP class=md-nav__link> OpenLDAP </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Keycloak </label> <a href=./ title=Keycloak class="md-nav__link md-nav__link--active"> Keycloak </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#set-secrets class=md-nav__link> Set Secrets </a> </li> <li class=md-nav__item> <a href=#deploy-keycloak class=md-nav__link> Deploy Keycloak </a> </li> <li class=md-nav__item> <a href=#setup-realm class=md-nav__link> Setup Realm </a> </li> <li class=md-nav__item> <a href=#user-federation-identity-provider-ldap class=md-nav__link> User Federation Identity Provider (LDAP) </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#settings class=md-nav__link> Settings </a> </li> <li class=md-nav__item> <a href=#mappers class=md-nav__link> Mappers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-groups-and-mappers class=md-nav__link> Create Groups and Mappers </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#realm-roles class=md-nav__link> Realm Roles </a> </li> <li class=md-nav__item> <a href=#groups class=md-nav__link> Groups </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#users class=md-nav__link> Users </a> </li> <li class=md-nav__item> <a href=#enabling-mfa class=md-nav__link> Enabling MFA </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#impersonate-user class=md-nav__link> Impersonate user </a> </li> <li class=md-nav__item> <a href=#login class=md-nav__link> Login </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#bootstrapping class=md-nav__link> Bootstrapping </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Snippets </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> Snippets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../99.snippets/storage.disks/ title=Storage class=md-nav__link> Storage </a> </li> <li class=md-nav__item> <a href=../../99.snippets/kubernetes/ title=Kubernetes class=md-nav__link> Kubernetes </a> </li> <li class=md-nav__item> <a href=../../99.snippets/ceph/ title=Ceph class=md-nav__link> Ceph </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#set-secrets class=md-nav__link> Set Secrets </a> </li> <li class=md-nav__item> <a href=#deploy-keycloak class=md-nav__link> Deploy Keycloak </a> </li> <li class=md-nav__item> <a href=#setup-realm class=md-nav__link> Setup Realm </a> </li> <li class=md-nav__item> <a href=#user-federation-identity-provider-ldap class=md-nav__link> User Federation Identity Provider (LDAP) </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#settings class=md-nav__link> Settings </a> </li> <li class=md-nav__item> <a href=#mappers class=md-nav__link> Mappers </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-groups-and-mappers class=md-nav__link> Create Groups and Mappers </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#realm-roles class=md-nav__link> Realm Roles </a> </li> <li class=md-nav__item> <a href=#groups class=md-nav__link> Groups </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#users class=md-nav__link> Users </a> </li> <li class=md-nav__item> <a href=#enabling-mfa class=md-nav__link> Enabling MFA </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#impersonate-user class=md-nav__link> Impersonate user </a> </li> <li class=md-nav__item> <a href=#login class=md-nav__link> Login </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#bootstrapping class=md-nav__link> Bootstrapping </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/darth-veitcher/homelab/edit/master/docs/02.idam/02.keycloak.md title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a> <h1>Keycloak</h1> <p><a href=https://www.keycloak.org>Keycloak</a> is an application from Red Hat which allows you to provide a variety of authentication options to applications you run from a single source. It also includes User Federation, Identity Brokering and Social Login.</p> <p>Here's a picture of the current capabilities advertised on their website.</p> <p><img alt=Features src="../img/Screenshot 2019-12-22 at 20.47.19.png"></p> <p>Whilst we <em>could</em> link Keycloak to a provider like GitHub (which would allow you to login to other applications with your GitHub username/password combination), instead we're going to manage our own users and Groups in OpenLDAP and have Keycloak sat in front of this directory server. This provides us much more scalability, control and flexibility.</p> <p>In order to deploy and run Keycloak we need the following:</p> <ul> <li>keycloak</li> <li>postgres</li> </ul> <p>Documentation is available on <a href=https://hub.docker.com/r/jboss/keycloak>Docker Hub</a></p> <h3 id=set-secrets>Set Secrets</h3> <p>As with OpenLDAP we will store our sensitive credentials into a secret. Feel free to use the manifest approach.</p> <p><strong>Keycloak</strong></p> <div class=highlight><pre><span></span>$ kubectl -n auth create secret generic keycloak-db-creds <span class=se>\</span>
      --from-literal<span class=o>=</span><span class=nv>DB_USER</span><span class=o>=</span>postgres <span class=se>\</span>
      --from-literal<span class=o>=</span><span class=nv>DB_PASSWORD</span><span class=o>=</span>admin

secret/keycloak-db-creds created
</pre></div> <div class=highlight><pre><span></span>$ kubectl -n auth create secret generic keycloak-user-creds <span class=se>\</span>
      --from-literal<span class=o>=</span><span class=nv>KEYCLOAK_USER</span><span class=o>=</span>admin <span class=se>\</span>
      --from-literal<span class=o>=</span><span class=nv>KEYCLOAK_PASSWORD</span><span class=o>=</span>password

secret/keycloak-user-creds created
</pre></div> <p><strong>Database</strong></p> <p>We want to use the same databse credentials but the postgres container uses a different environment variable name. As such we will remap to a different key in the spec for the container.</p> <table> <thead> <tr> <th>Keycloak</th> <th>Postgres</th> </tr> </thead> <tbody> <tr> <td>POSTGRES_USER</td> <td>DB_USER</td> </tr> <tr> <td>POSTGRES_PASSWORD</td> <td>DB_PASSWORD</td> </tr> </tbody> </table> <p>The mapping will look like this.</p> <div class=highlight><pre><span></span><span class=nn>...</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>containers</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db</span>
    <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:alpine</span>
    <span class=nt>env</span><span class=p>:</span>
    <span class=c1># Secrets</span>
<span class=hll>    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER</span>
</span>      <span class=nt>valueFrom</span><span class=p>:</span>
        <span class=nt>secretKeyRef</span><span class=p>:</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-creds</span>
          <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DB_USER</span>
<span class=hll>    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD</span>
</span>        <span class="l l-Scalar l-Scalar-Plain">secretKeyRef</span><span class="p p-Indicator">:</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-creds</span>
          <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DB_PASSWORD</span>
    <span class=c1># Regular environment variables from configmap</span>
    <span class=nt>envFrom</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config</span>
    <span class=nt>ports</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class=nn>...</span>
</pre></div> <h3 id=deploy-keycloak>Deploy Keycloak</h3> <details class=example><summary>Keycloak manifest</summary><div class=highlight><pre><span></span><span class=c1># file: ~/auth/keycloak.yaml</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1alpha2</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Certificate</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>secretName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-certs</span>
  <span class=nt>duration</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2160h</span> <span class=c1># 90d</span>
  <span class=nt>renewBefore</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">360h</span> <span class=c1># 15d</span>
  <span class=nt>organization</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jamesveitch</span>
  <span class=nt>commonName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth.jamesveitch.dev</span>
  <span class=nt>isCA</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class=nt>keySize</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">2048</span>
  <span class=nt>keyAlgorithm</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">rsa</span>
  <span class=nt>keyEncoding</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">pkcs1</span>
  <span class=nt>usages</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">server auth</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">client auth</span>
  <span class=nt>dnsNames</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">auth.jamesveitch.dev</span>
  <span class=nt>issuerRef</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt</span>
    <span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
    <span class=nt>group</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">cert-manager.io</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-external-ingress</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
  <span class=nt>annotations</span><span class=p>:</span>
    <span class=nt>kubernetes.io/ingress.class</span><span class=p>:</span> <span class=s>&quot;nginx&quot;</span>
    <span class=nt>cert-manager.io/issuer</span><span class=p>:</span> <span class=s>&quot;letsencrypt&quot;</span>
    <span class=nt>nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class=p>:</span> <span class=s>&quot;true&quot;</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>tls</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">auth.jamesveitch.dev</span>
    <span class=nt>secretName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-certs</span>
  <span class=nt>rules</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>host</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth.jamesveitch.dev</span>
    <span class=nt>http</span><span class=p>:</span>
      <span class=nt>paths</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
        <span class=nt>backend</span><span class=p>:</span>
          <span class=nt>serviceName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
          <span class=nt>servicePort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
  <span class=nt>ports</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
      <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
      <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-config</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>DB_ADDR</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db.auth</span>
  <span class=c1># This is required to run keycloak behind a service,ingress etc       </span>
  <span class=nt>PROXY_ADDRESS_FORWARDING</span><span class=p>:</span> <span class=s>&quot;true&quot;</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-deployment</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>replicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>matchLabels</span><span class=p>:</span>
      <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
      <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
  <span class=nt>strategy</span><span class=p>:</span>
    <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Recreate</span>
  <span class=nt>template</span><span class=p>:</span>
    <span class=nt>metadata</span><span class=p>:</span>
      <span class=nt>labels</span><span class=p>:</span>
        <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
        <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jboss/keycloak</span>
        <span class=nt>envFrom</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>secretRef</span><span class=p>:</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-creds</span>
        <span class="p p-Indicator">-</span> <span class=nt>secretRef</span><span class=p>:</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-user-creds</span>
        <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-config</span>
        <span class=nt>ports</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class=nt>data</span><span class=p>:</span>
  <span class=nt>POSTGRES_DB</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
  <span class=nt>PGDATA</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data/pgdata</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-data-pv-claim</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>accessModes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class=nt>resources</span><span class=p>:</span>
    <span class=nt>requests</span><span class=p>:</span>
      <span class=nt>storage</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">20Gi</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config-pv-claim</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>accessModes</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class=nt>resources</span><span class=p>:</span>
    <span class=nt>requests</span><span class=p>:</span>
      <span class=nt>storage</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
  <span class=nt>ports</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
      <span class=nt>protocol</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class=nt>port</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">5432</span>
      <span class=nt>targetPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">5432</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=nt>kind</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=nt>metadata</span><span class=p>:</span>
  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-deployment</span>
  <span class=nt>namespace</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">auth</span>
  <span class=nt>labels</span><span class=p>:</span>
    <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
    <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class=nt>spec</span><span class=p>:</span>
  <span class=nt>replicas</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class=nt>selector</span><span class=p>:</span>
    <span class=nt>matchLabels</span><span class=p>:</span>
      <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
      <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
  <span class=nt>strategy</span><span class=p>:</span>
    <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Recreate</span>
  <span class=nt>template</span><span class=p>:</span>
    <span class=nt>metadata</span><span class=p>:</span>
      <span class=nt>labels</span><span class=p>:</span>
        <span class=nt>app</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak</span>
        <span class=nt>tier</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class=nt>spec</span><span class=p>:</span>
      <span class=nt>containers</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db</span>
        <span class=nt>image</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres:alpine</span>
        <span class=nt>env</span><span class=p>:</span>
          <span class=c1># Secrets</span>
          <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER</span>
            <span class=nt>valueFrom</span><span class=p>:</span>
              <span class=nt>secretKeyRef</span><span class=p>:</span>
                <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-creds</span>
                <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DB_USER</span>
          <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD</span>
            <span class=nt>valueFrom</span><span class=p>:</span>
              <span class=nt>secretKeyRef</span><span class=p>:</span>
                <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-creds</span>
                <span class=nt>key</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DB_PASSWORD</span>
        <span class=nt>envFrom</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>configMapRef</span><span class=p>:</span>
            <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config</span>
        <span class=nt>ports</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>containerPort</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">5432</span>
          <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
        <span class=nt>volumeMounts</span><span class=p>:</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-data</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
        <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config</span>
          <span class=nt>mountPath</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/share/postgresql</span>
      <span class=nt>volumes</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-data</span>
        <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
          <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-data-pv-claim</span>
      <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config</span>
        <span class=nt>persistentVolumeClaim</span><span class=p>:</span>
          <span class=nt>claimName</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">keycloak-db-config-pv-claim</span>
</pre></div> </details> <p>Apply the manifest with <code>kubectl apply -f ~/auth/keycloak.yaml</code> and then wait for the pods, services, ingress and certificate to be provisioned. The keycloak container can take up to a minute to properly start up so you can monitor this be looking at the logs for the <code>keycloak-deployment*</code> pod.</p> <div class=highlight><pre><span></span>$ kubectl get pod -n auth

NAME                                      READY   STATUS    RESTARTS   AGE
keycloak-db-deployment-5d8846dbf9-2dfdh   <span class=m>1</span>/1     Running   <span class=m>0</span>          14h
<span class=hll>keycloak-deployment-88bc75877-f8cbr       <span class=m>1</span>/1     Running   <span class=m>0</span>          14h
</span>ldap-deployment-7864dd96cf-9jvmz          <span class=m>1</span>/1     Running   <span class=m>0</span>          15h
ldapadmin-deployment-7575c6d9dc-vb47b     <span class=m>1</span>/1     Running   <span class=m>0</span>          15h

$ kubectl -n auth logs keycloak-deployment-88bc75877-f8cbr

...
<span class=m>23</span>:56:53,676 INFO  <span class=o>[</span>org.jboss.as<span class=o>]</span> <span class=o>(</span>Controller Boot Thread<span class=o>)</span> WFLYSRV0060: Http management interface listening on http://127.0.0.1:9990/management
<span class=m>23</span>:56:53,676 INFO  <span class=o>[</span>org.jboss.as<span class=o>]</span> <span class=o>(</span>Controller Boot Thread<span class=o>)</span> WFLYSRV0051: Admin console listening on http://127.0.0.1:9990
<span class=m>23</span>:56:53,676 INFO  <span class=o>[</span>org.jboss.as<span class=o>]</span> <span class=o>(</span>Controller Boot Thread<span class=o>)</span> WFLYSRV0025: Keycloak <span class=m>8</span>.0.1 <span class=o>(</span>WildFly Core <span class=m>10</span>.0.3.Final<span class=o>)</span> started in 29506ms - Started <span class=m>684</span> of <span class=m>989</span> services <span class=o>(</span><span class=m>701</span> services are lazy, passive or on-demand<span class=o>)</span>
</pre></div> <h3 id=setup-realm>Setup Realm</h3> <p>As per the <a href=https://www.keycloak.org/docs/latest/server_admin/index.html#core-concepts-and-terms>docs</a></p> <details class=quote open=open><summary>Realm</summary><p>A realm manages a set of users, credentials, roles, and groups. A user belongs to and logs into a realm. Realms are isolated from one another and can only manage and authenticate the users that they control.</p> </details> <p>We'll create a realm specifically for <code>jamesveitch.dev</code>.</p> <p>Navigate to <a href=https://auth.jamesveitch.dev>auth.jamesveitch.dev</a> &rarr; <code>Administration Console</code> and login with the <code>KEYCLOAK_USER</code> and <code>KEYCLOAK_PASSWORD</code> set in the deployment. This will get you into the <code>Master</code> realm initially.</p> <p>Hover over the drop down arrow next to <code>Master</code> in the top left and select <code>Add realm</code>. Call it <code>development</code>.</p> <details class=example><summary>Add realm</summary><p><img alt="Add Realm" src="../img/Screenshot 2019-12-22 at 00.02.07.png"></p> </details> <h3 id=user-federation-identity-provider-ldap>User Federation Identity Provider (LDAP)</h3> <p>To configure Keycloak to work with OpenLDAP we need to login and setup our <code>ldap</code> container as a <code>User Federation</code> provider.</p> <p><img alt="Add Provider" src="../img/Screenshot 2019-12-24 at 00.33.03.png"></p> <h4 id=settings>Settings</h4> <p>Key settings you'll need to modify are as follows:</p> <ul> <li><code>Edit Mode</code>: WRITABLE</li> <li><code>Sync Registrations</code>: On</li> <li><code>Vendor</code>: Other</li> <li><code>Connection URL</code>: ldap://ldap.auth</li> <li><code>Users DN</code>: ou=People,dc=jamesveitch,dc=dev</li> <li><code>Bind DN</code>: cn=admin,dc=jamesveitch,dc=dev</li> <li><code>Bind Credential</code>: <insert admin password></li> <li><code>Search Scope</code>: Subtree</li> </ul> <p>(Optionally)</p> <ul> <li><code>Periodic Full Sync</code>: On (and keep defaults for the <code>Period</code>)</li> <li><code>Periodic Changed Users Sync</code>: On (and set <code>Period</code> to <code>5</code>) <!-- * <code>Cache Policy</code>: Set to <code>NO_CACHE</code> for now --></li> </ul> <!-- #TODO: Implement StartTLS with trusted certs --> <details class=example><summary>Identity Provider Configuration (Settings)</summary><p><img alt="Page 1" src="../img/Screenshot 2019-12-24 at 00.38.19.png"> <img alt="Page 2" src="../img/Screenshot 2019-12-24 at 00.38.33.png"> <img alt="Page 3" src="../img/Screenshot 2019-12-24 at 00.38.46.png"></p> </details> <p>Hit <code>Save</code> &rarr; <code>Synchronize all users</code> and you should see a success flash message appear at the top of the screen.</p> <p><img alt=Success src="../img/Screenshot 2019-12-24 at 00.47.02.png"></p> <h4 id=mappers>Mappers</h4> <p>Mappers help to provide a translation layer between how data is stored in the provider and how we'd like to use it in Keycloak. For example, there are some standard ones created for you automatically based on your selection of the <code>Vendor</code> in the previous <code>Settings</code> tab.</p> <p><img alt="Default Mappings" src="../img/Screenshot 2019-12-21 at 13.27.18.png"></p> <p>Clicking on the <code>username</code> will show you that:</p> <ul> <li><code>Type</code>: It's a <code>user-attribute</code> mapper (used to map a single attribute from a LDAP user to the Keycloak user model)</li> <li><code>Model Attribute</code>: This is what the attribute will be called in Keycloak</li> <li><code>LDAP Attribute</code>: What the attribute is called in LDAP</li> </ul> <details class=example><summary>Username attribute-ldap-mapper</summary><p><img alt=Username src="../img/Screenshot 2019-12-21 at 13.28.23.png"></p> </details> <p>We are going to add some of our own custom mappers so that we can do things like identify what security groups a user is part of and, therefore, what resources they should be able to access inside Kubernetes.</p> <h3 id=create-groups-and-mappers>Create Groups and Mappers</h3> <p>As we created a number of Groups <a href=../01.openldap#admin>in our previous step</a> (or have seeded with an LDIF) we need to tell Keycloak how to find and interpret them.</p> <p>Go back into our <code>User Federation</code> &rarr; <code>Ldap</code> &rarr; <code>Mappers</code> and create two new ones.</p> <h4 id=realm-roles>Realm Roles</h4> <p>This is a special mapping which will allow us to automatically allocate people to the right roles within the Keycloak administration setup.</p> <ul> <li><code>Name</code>: realm roles</li> <li><code>Type</code>: role-ldap-mapper</li> <li><code>LDAP Groups DN</code>: ou=RealmRoles,ou=Groups,dc=jamesveitch,dc=dev</li> <li><code>Use Realm Roles Mapping</code>: ON</li> </ul> <p>Click <code>Save</code> &rarr; <code>Sync LDAP Roles To Keycloak</code></p> <p><img alt=Success src="../img/Screenshot 2019-12-24 at 00.52.08.png"></p> <p>Navigating to <strong>Roles</strong> in the menu should show now our LDAP roles populated as <code>ldap-admin</code>, <code>ldap-user</code> and <code>realm-admin</code></p> <p><img alt=Roles src="../img/Screenshot 2019-12-24 at 00.53.58.png"></p> <p>In addition, navigating to <strong>Users</strong> and then clicking into our user should show, on the <strong>Role Mappings</strong> tab, that we have these roles assigned to us.</p> <p>We need to give this role some powers. In order to administer the <code>development</code> realm click on the <code>realm-admin</code> role and then turn <code>Composite Roles</code> to <code>ON</code>. From the <code>Client Roles</code> drop-down select <code>realm-management</code> then assign <code>realm-admin</code>.</p> <details class=example><summary>Assign <code>realm-admin</code> powers</summary><p><img alt=Realm-Admin src="../img/Screenshot 2019-12-24 at 01.13.35.png"></p> </details> <p>Navigate to <a href=https://auth.jamesveitch.dev/auth/realms/development>https://auth.jamesveitch.dev/auth/realms/development/account/</a> and you should be able to login now as that user and manage your account.</p> <p>Navigate to <a href=https://auth.jamesveitch.dev/auth/admin/development/console>https://auth.jamesveitch.dev/auth/admin/development/console</a> and you should be able to administer the domain.</p> <h4 id=groups>Groups</h4> <p>This mapping will allow us to find any groups within the <code>Groups</code> OU and then map them automatically to users.</p> <ul> <li><code>Name</code>: groups</li> <li><code>Type</code>: group-ldap-mapper</li> <li><code>LDAP Groups DN</code>: ou=Groups,dc=jamesveitch,dc=dev</li> <li><code>Mapped Group Attributes</code>: description</li> </ul> <p>Click on the <code>Sync LDAP Groups To Keycloak</code> button on each one down the bottom after saving the mapper and ensure you get a success overlay message that it's now imported the Groups we created earlier. Go to the <code>Settings</code> tab and then, down the bottom, click <code>Synchronize all users</code> to get a message about one user being updated (because it's now spotted some groups we're part of).</p> <h3 id=users>Users</h3> <p>Go to <code>Users</code> and then click <code>View all users</code> to force it to perform an initial sync. You should see your user appear with an additional <code>admin</code> user (if using Master realm).</p> <p>If you now select your user you should note on the <code>Groups</code> tab you have a <code>Group Membership</code> identified for all of the groups you're part of. In addition you have <code>admin</code> as an <code>Effective Role</code> in the <code>Role Mappings</code> tab (once you select <code>realm-management</code> from the <code>Client Roles</code> drop down) because it's mapped this through from your membership of the <code>realm-admin</code> group.</p> <details class=example><summary>User: Group Membership</summary><p><img alt="Group Membership" src="../img/Screenshot 2019-12-24 at 01.14.58.png"></p> </details> <details class=example><summary>User: Role Mapping</summary><p><img alt="Group Mapping" src="../img/Screenshot 2019-12-24 at 01.17.49.png"></p> </details> <h3 id=enabling-mfa>Enabling MFA</h3> <p>Stealing with pride from documentation elsewhere we're going to enable TOTP based MFA for our initial user.</p> <p>In the GUI you would navigate to <code>Authentication</code> &rarr; <code>OTP Policy</code> and then update the following settings as required. The below are those we're using:</p> <ul> <li><code>OTP Type</code>: Time Based</li> <li><code>OTP Hash Algorith</code>: SHA512</li> <li><code>Number of Digits</code>: 8</li> <li><code>Look Ahead Window</code>: 3</li> <li><code>OTP Token Period</code>: 30</li> </ul> <p>Depending on appetite we can also navigate to the <code>Authentication</code> &rarr; <code>Required Actions</code> tab and tick the <code>Default Action</code> box against <code>Configure OTP</code> if we want to enforce this for everyone by default.</p> <h4 id=impersonate-user>Impersonate user</h4> <p>Navigate to <code>Users</code> and then select <code>Impersonate</code> next to ours. This should change and give you a different screen where we can now setup MFA for our user. Select the <code>Authenticator</code> option and follow the instructions to get setup.</p> <h4 id=login>Login</h4> <p>Logout using the <code>Sign Out</code> button in the top right of the screen and then attempt to sign back in with your new user. You'll be presented with the below requiring you to input a code from your app.</p> <p><img alt=MFA src="../img/Screenshot 2019-12-21 at 16.33.49.png"></p> <h3 id=bootstrapping>Bootstrapping</h3> <p>We'll, later, bootstrap this into Keycloak via the <a href=https://github.com/jboss-dockerfiles/keycloak/tree/master/server#importing-a-realm>Importing a realm</a> option. The easiest way to get your configuration back out of the system is to go the <code>Export</code> setting and then get the JSON output.</p> <p>Unfortunately, due to the way in which the image is configured, the given method in the docs doesn't work (as volumes are mounted by <code>root</code> yet the application executes as the <code>jboss</code> user and therefore can't access the files). As a result we'll inherit from and build a custom image with a <code>/realms</code> folder that we can mount the JSON files into. #TODO: update with custom image.</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../01.openldap/ title=OpenLDAP class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> OpenLDAP </span> </div> </a> <a href=../../99.snippets/storage.disks/ title=Storage class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> Storage </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight id=copy> <!-- &copy Darth Veitcher 2019-&date --> </div> <script type=text/javascript>
            let theDate=new Date();
            copy.innerHTML = "&copy Darth Veitcher "+theDate.getFullYear();
        </script> </div> <div class=md-footer-social> <link rel=stylesheet href=../../assets/fonts/font-awesome.css> <a href=https://github.com/darth-veitcher class="md-footer-social__link fa fa-github"></a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/application.808e90bb.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>