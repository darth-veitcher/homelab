We need the following:

* keycloak
* postgres
* postgres (backup)

Documentation is available on [Docker Hub](https://hub.docker.com/r/jboss/keycloak)

```yaml
# file: ~/idam/keycloak.yaml
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: keycloak
  namespace: idam
spec:
  secretName: keycloak-certs
  duration: 2160h # 90d
  renewBefore: 360h # 15d
  organization:
  - jamesveitch
  commonName: auth.jamesveitch.dev
  isCA: false
  keySize: 2048
  keyAlgorithm: rsa
  keyEncoding: pkcs1
  usages:
    - server auth
    - client auth
  dnsNames:
  - auth.jamesveitch.dev
  issuerRef:
    name: letsencrypt
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: keycloak-external-ingress
  namespace: idam
  labels:
    app: keycloak
    tier: frontend
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/issuer: "letsencrypt"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  tls:
   - hosts:
     - auth.jamesveitch.dev
     secretName: keycloak-certs
  rules:
  - host: auth.jamesveitch.dev
    http:
      paths:
      - path: /
        backend:
          serviceName: keycloak
          servicePort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: idam
  labels:
    app: keycloak
    tier: frontend
spec:
  selector:
    app: keycloak
    tier: frontend
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: idam
  labels:
    app: keycloak
    tier: frontend
data:
  DB_ADDR: keycloak-db.idam
  DB_USER: postgres
  DB_PASSWORD: postgres
  KEYCLOAK_USER: admin
  KEYCLOAK_PASSWORD: password
  # This is required to run keycloak behind a service,ingress etc		
  PROXY_ADDRESS_FORWARDING: "true"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak-deployment
  namespace: idam
  labels:
    app: keycloak
    tier: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
      tier: frontend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: keycloak
        tier: frontend
    spec:
      containers:
      - name: keycloak
        image: jboss/keycloak
        envFrom:
        - configMapRef:
            name: keycloak-config
        ports:
        - containerPort: 8080
          name: keycloak
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-db-config
  namespace: idam
  labels:
    app: keycloak
    tier: postgres
data:
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: keycloak
  PGDATA: /var/lib/postgresql/data/pgdata
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: keycloak-db-data-pv-claim
  namespace: idam
  labels:
    app: keycloak
    tier: postgres
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: keycloak-db-config-pv-claim
  namespace: idam
  labels:
    app: keycloak
    tier: postgres
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak-db
  namespace: idam
  labels:
    app: keycloak
    tier: postgres
spec:
  selector:
    app: keycloak
    tier: postgres
  ports:
    - name: postgres
      protocol: TCP
      port: 5432
      targetPort: 5432
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak-db-deployment
  namespace: idam
  labels:
    app: keycloak
    tier: postgres
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
      tier: postgres
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: keycloak
        tier: postgres
    spec:
      containers:
      - name: keycloak-db
        image: postgres:alpine
        envFrom:
        - configMapRef:
            name: keycloak-db-config
        ports:
        - containerPort: 5432
          name: postgres
        volumeMounts:
        - name: keycloak-db-data
          mountPath: /var/lib/postgresql/data
        - name: keycloak-db-config
          mountPath: /usr/share/postgresql
      volumes:
      - name: keycloak-db-data
        persistentVolumeClaim:
          claimName: keycloak-db-data-pv-claim
      - name: keycloak-db-config
        persistentVolumeClaim:
          claimName: keycloak-db-config-pv-claim
```

# Configuring Keycloak
To configure Keycloak to work with OpenLDAP we need to login and setup our `ldap` container as a `User Federation` provider.

Key setting as follows:

* `Vendor`: Other
* `Edit Mode`: WRITABLE
* `Connection URL`: ldap://ldap.idam
* `Users DN`: ou=People,dc=jamesveitch,dc=dev
* `Bind DN`: cn=admin,dc=jamesveitch,dc=dev
* `Bind Credential`: <insert admin password>

We bootstrap this into Keycloak via the [Importing a realm](https://github.com/jboss-dockerfiles/keycloak/tree/master/server#importing-a-realm) option. The easiest way to get this back out of the system is to go the `Export` setting and then get the JSON output.

Unfortunately, due to the way in which the image is configured, the given method in the docs doesn't work (as volumes are mounted by `root` yet the application executes as the `jboss` user and therefore can't access the files). As a result we inherit from and build a custom image with a `/realms` folder that we can mount the JSON files into.


## Enabling MFA
Stealing with pride from documentation elsewhere we're going to enable TOTP based MFA for our initial user.

In the GUI you would navigate to `Authentication` --> `OTP Policy` and then update the following settings as required. The below are those we're using:

* `OTP Type`: Time Based
* `OTP Hash Algorith`: SHA256
* `Number of Digits`: 8
* `Look Ahead Window`: 3
* `OTP Token Period`: 30

Depending on appetite we can also navigate to the `Authentication` --> `Required Actions` tab and tick the `Default Action` box against `Configure OTP` if we want to enforce this for everyone by default.


## Accessing account and admin console
The admin console and account details can be accessed from the following urls:

* [Security Admin Console](http://keycloak.jamesveitch.local:8080/auth/admin/homelab/consoledevindex.html)
* [Account](http://keycloak.jamesveitch.local:8080/auth/realms/homelab/accountdev