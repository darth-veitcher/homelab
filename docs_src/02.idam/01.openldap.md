We're going to follow a previous tutorial I wrote for setting up an initial OpenLDAP installation on a VM and then seed an initial admin user. Dockerising this is done now with the `osixia/openldap` base image which can be found on [GitHub](https://github.com/osixia/docker-openldap).		

```bash
mkdir -p ~/idam; \
cd ~/idam
```

??? example "OpenLDAP manifest"

    ```yaml
    # file: ~/idam/ldap.yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: ldap-config
      namespace: idam
      labels:
        app: ldap
        tier: backend
    data:
      LDAP_ORGANISATION: James Veitch
      LDAP_DOMAIN: jamesveitch.dev
      LDAP_ADMIN_PASSWORD: admin
      LDAP_CONFIG_PASSWORD: config
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ldap-data-pv-claim
      namespace: idam
      labels:
        app: ldap
        tier: backend
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 20Gi
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ldap-config-pv-claim
      namespace: idam
      labels:
        app: ldap
        tier: backend
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ldap-certs-pv-claim
      namespace: idam
      labels:
        app: ldap
        tier: backend
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: ldap
      namespace: idam
      labels:
        app: ldap
        tier: backend
    spec:
      selector:
        app: ldap
        tier: backend
      ports:
        - name: ldap
          protocol: TCP
          port: 389
          targetPort: 389
        - name: ldaps-tcp
          protocol: TCP
          port: 636
          targetPort: 636
        - name: ldaps
          protocol: UDP
          port: 636
          targetPort: 636
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: ldap-deployment
      namespace: idam
      labels:
        app: ldap
        tier: backend
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: ldap
          tier: backend
      strategy:
        type: Recreate
      template:
        metadata:
          labels:
            app: ldap
            tier: backend
        spec:
          containers:
          - name: ldap
            image: osixia/openldap
            envFrom:
            - configMapRef:
                name: ldap-config
            ports:
            - containerPort: 389
              name: ldap
            - containerPort: 636
              name: ldaps
            volumeMounts:
            - name: ldap-data
              mountPath: /var/lib/ldap
            - name: ldap-config
              mountPath: /etc/ldap/slapd.d
            - name: ldap-certs
              mountPath: /container/service/slapd/assets/certs
          volumes:
          - name: ldap-data
            persistentVolumeClaim:
              claimName: ldap-data-pv-claim
          - name: ldap-config
            persistentVolumeClaim:
              claimName: ldap-config-pv-claim
          - name: ldap-certs
            persistentVolumeClaim:
              claimName: ldap-certs-pv-claim
    ```

Apply this manifest with a `~/idam/ldap.yaml` and then wait for the services and pods to spin up.

# Admin
If you haven't used a pre-canned LDIF file to seed the initial database we can use a friendly admin tool to quickly add some content into the LDAP backend.

??? example "LDAP Admin manifest"

    ```yaml
    # file: ~/idam/ldap-admin.yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: ldapadmin-config
      namespace: idam
      labels:
        app: ldap
        tier: frontend
    data:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap.idam"
      PHPLDAPADMIN_HTTPS: "false"
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: ldapadmin
      namespace: idam
      labels:
        app: ldap
        tier: frontend
    spec:
      type: LoadBalancer
      selector:
        app: ldap
        tier: frontend
      ports:
        - name: http
          protocol: TCP
          port: 80
          targetPort: 80
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: ldapadmin-deployment
      namespace: idam
      labels:
        app: ldap
        tier: frontend
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: ldap
          tier: frontend
      strategy:
        type: Recreate
      template:
        metadata:
          labels:
            app: ldap
            tier: frontend
        spec:
          containers:
          - name: ldapadmin
            image: osixia/phpldapadmin
            envFrom:
            - configMapRef:
                name: ldapadmin-config
            ports:
            - containerPort: 80
              name: http
    ```

This creates an internal (to the LAN) `Service` using a `LoadBalancer` so it appears on the network via MetalLB. To get the `External-IP` query the services in the namespace.

```bash hl_lines="5"
$ kubectl get svc -n idam

NAME          TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                   AGE
ldap          ClusterIP      10.96.236.102   <none>          389/TCP,636/TCP,636/UDP   14h
ldapadmin     LoadBalancer   10.96.165.63    192.168.0.201   80:30158/TCP              14h
```

To login to the admin panel you'll need to use the username of `cn=admin,dc=jamesveitch,dc=dev` and then the password.

One the left you should see something similar to the below. Click to `Create new entry here` so we can add the necessary Organisational Units we'll require later on.

![Create new entry](img/Screenshot 2019-12-21 at 13.55.29.png)

In the screen that appears choose `Generic: Organisational Unit` and then call it `People`. Click through the screens and commit to the database.

??? tip "Generic: Organisational Unit"
    ![OU](img/Screenshot 2019-12-21 at 13.58.04.png)

If you click on this new `ou=People` icon and then `Add new attribute` you'll see down the bottom we can select `description` from a drop-down box. Type in something descriptive.

>LDAP tree where users are

??? tip "Add description"
    ![Select](img/Screenshot 2019-12-21 at 14.15.10.png)

## Additional entries
After adding the above, we need to create the following structure.

* `Organisational Units`: Create these in the same way as above (`Generic: Organisational Unit` and then add a description attribute).
  * `People`: LDAP tree where users are
  * `Groups`: LDAP tree for Groups that users belong to
    * `RealmRoles`: Keycloak roles that users have
* `Groups`: These sit inside the `Groups` OU tree and should be created as a `Posix Group`.
  * `users`: Standard group for all users
  * `admins`: Holds general administrators for the domain
  * `auth-admins`: Sits inside `RealmRoles` OU. Administrators for Keycloak and LDAP
* `Users`: These sit inside the `People` OU tree and should be created as a `Generic: User Account`
  * `jamesveitch`: Obviously replace with another name... This will be our standard admin user going forwards. Add them to the `users` group initially (where it says `GID`).

Make note of both your user's `Distinguished Name` (DN) as we need this. It will look something like `cn=James Veitch,ou=People,dc=jamesveitch,dc=dev`. Now go into each of `users`, `admins` and `auth-admins` Groups and add our user into them with `Add new attribute` --> `memberUid` and use the DN.

# Export configuration as LDIF
The *really* helpful thing about this admin interface is that it contains an `Export` functionality we can use to save down a copy of our databse for subsequent seeding / backup.

Make sure you set the following:

* `Base DN`: use the root `dc=jamesveitch,dc=dev`
* `Search Scope`: Select the entire subtree
* `Attributes`: Keep the wildcard `*`
* `Save as file`: Select this
* `Export format`: LDIF
* `Line ends`: UNIX

??? tip "Export"
    ![Export](img/Screenshot 2019-12-21 at 14.27.33.png)
    ![Export Settings](img/Screenshot 2019-12-21 at 14.27.46.png)


#TODO: Seed the database with an LDIF
See [seed-ldap-database-with-ldif](https://github.com/osixia/docker-openldap#seed-ldap-database-with-ldif) from the docs.