For the Kubernetes ingress node I'm going to use a cheap (<$5 per month) dedicated server from [Kimsufi](https://www.kimsufi.com) which has unmetered traffic and 100mb bandwidth. This will allow me to have a static IP4 address to point my DNS records at whilst then using the internal wireguard VPN to route traffic from here back home / elsewhere in a secure fashion.

# Boot into `rescue`
We need to set our cloud node to boot into a LiveCD `rescue` image so that we can then login and install CoreOS to our main disk.

## Kimsufi Control Panel
Login to the kimsufi control panel and select `Netboot` from the options against your server. Step through te options provided and select `Rescue` --> `rescue64-pro`.

Now restart the server and wait for an email confirming your temporary ssh login credentials.

# Install CoreOS
## Installation
SSH into the box with the temporary credentials and use the CoreOS installer script to overwrite and nuke current installation by OVH. <u>Make sure we've transferred across our ignition file with ssh key and hostname etc.</u>

```bash
wget https://raw.github.com/coreos/init/master/bin/coreos-install; \
chmod +x coreos-install; \
sudo ./coreos-install -d /dev/sda -i ignition.json
```

Once you see a `Success! CoreOS Container Linux stable 2303.3.0 is installed on /dev/sda` we can reboot (after changing the boot option in the control panel).

## Kimsufi Control Panel
Now go back to the control panel and change the boot to `Hard disk` before then rebooting.

# Configure Kubernetes
Follow the existing instructions, remembering to change for your hostname and also use `kimsufi` as region when labelling the node.

## Node stuck on "Not Ready"
If the node, even after applying the CNI, is still stuck on `Not Ready` check the following.

* output from `systemctl status kubelet`
* output from `kubectl describe node <nodename>`

Chances are you have the same problem I ended up with originally of CoreOS being unable to find the correct CNI configuration file.

???+ error "Unable to update cni config: no networks found in /etc/cni/net.d"
    If you're seeing this error in the output from `systemctl` then the fix is to manually drop in the necessary configuration based on the CNI selected.

    The way to find this is to actually do the install properly somewhere else and then see which files are written to that folder... I ended up running an ubuntu vm for this purpose. So follow the instructions [here]() with the `Ubuntu` tabs.

    If you just want the configs I've put copies of the most common ones [here]() in the repo.

Also https://docs.projectcalico.org/v3.11/reference/faq#are-the-calico-manifests-compatible-with-coreos

```bash
export OLD=/usr/libexec/kubernetes/kubelet-plugins/volume/exec/nodeagent~uds
export NEW=/var/lib/kubelet/volumeplugins/nodeagent~uds
sed -i -e "s?$OLD?$NEW?g" ~/calico/calico.yaml
```

# Calico: The hard way
Because reasons... CoreOS doesn't seem to like Calico or allow the default configuration manifests to install to either `/etc/cni/net.d` or to `/opt/cni/bin`.

```bash
# run as root
sudo -s
```

We will manually add the necessary binaries follwing the guidance in [Install the plugin](https://docs.projectcalico.org/v3.11/getting-started/kubernetes/hardway/install-cni-plugin#install-the-plugin).

```bash
export CALICO_VERSION=v3.11.0
curl -L -o /opt/cni/bin/calico https://github.com/projectcalico/cni-plugin/releases/download/${CALICO_VERSION}/calico-amd64
chmod 755 /opt/cni/bin/calico
curl -L -o /opt/cni/bin/calico-ipam https://github.com/projectcalico/cni-plugin/releases/download/${CALICO_VERSION}/calico-ipam-amd64
chmod 755 /opt/cni/bin/calico-ipam
```

Create the config directory

```bash
mkdir -p /etc/cni/net.d/
```

Now manually create our config

```bash
sudo tee /etc/cni/net.d/10-calico.conflist <<EOF
{
  "name": "k8s-pod-network",
  "cniVersion": "0.3.1",
  "plugins": [
    {
      "type": "calico",
      "log_level": "info",
      "datastore_type": "kubernetes",
      "nodename": "test",
      "mtu": 1440,
      "ipam": {
          "type": "calico-ipam"
      },
      "policy": {
          "type": "k8s"
      },
      "kubernetes": {
          "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
      }
    },
    {
      "type": "portmap",
      "snat": true,
      "capabilities": {"portMappings": true}
    }
  ]
}
EOF
```